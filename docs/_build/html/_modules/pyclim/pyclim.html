

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyclim.pyclim &mdash; pyClim 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />


      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



          <a href="../../index.html" class="icon icon-home">
            pyClim
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Sections:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">How to use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyClim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyclim.pyclim</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <h1>Source code for pyclim.pyclim</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.offsetbox</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnchoredText</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1">##############################################################</span>
<span class="c1">#### Python module for climatological data analysis ##########</span>
<span class="c1">#### Author: Alejandro Rodríguez Sánchez #####################</span>
<span class="c1">#### Contact: ars.rodriguezs@gmail.com #######################</span>
<span class="c1">##############################################################</span>

<div class="viewcode-block" id="quality_control">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.quality_control">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">quality_control</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">vars_to_check</span><span class="p">,</span> <span class="n">t_units</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">wind_units</span><span class="o">=</span><span class="s1">&#39;m/s&#39;</span><span class="p">,</span> <span class="n">t_upper</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">t_lower</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span> <span class="n">wind_upper</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to perform a quality control in a DataFrame and returns it without suspicious or bad data.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    vars_to_check: list</span>
<span class="sd">        List of columns to check</span>
<span class="sd">    t_units: str</span>
<span class="sd">        The initial letter of the temperature scale (C for Celsius; F for Fahrenheit; K for Kelvin)</span>
<span class="sd">    wind_units: str</span>
<span class="sd">        The wind units (km/h for kilometers per hour; m/s for meters per second; mph for miles per hour; or kn for knots)</span>

<span class="sd">    t_upper: float</span>
<span class="sd">        The maximum allowed temperature value (in Celsius)</span>
<span class="sd">    t_lower: float</span>
<span class="sd">        The minimum allowed temperature value (in Celsius)</span>
<span class="sd">    wind_upper: float</span>
<span class="sd">        The maximum allowed wind speed value (in km/h)</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    cured_df: DataFrame</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">upper_t_limit</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">upper_wind_limit</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lower_t_limit</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">upper_t_limit</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_upper</span>
    <span class="n">upper_t_limit</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_upper</span><span class="o">*</span><span class="mf">1.8</span> <span class="o">+</span><span class="mi">32</span>
    <span class="n">upper_t_limit</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_upper</span> <span class="o">+</span> <span class="mf">273.15</span>

    <span class="n">lower_t_limit</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_lower</span>
    <span class="n">lower_t_limit</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_lower</span><span class="o">*</span><span class="mf">1.8</span> <span class="o">+</span> <span class="mi">32</span>
    <span class="n">lower_t_limit</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_lower</span> <span class="o">+</span> <span class="mf">273.15</span>

    <span class="n">upper_wind_limit</span><span class="p">[</span><span class="s1">&#39;km/h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wind_upper</span> <span class="c1">#200</span>
    <span class="n">upper_wind_limit</span><span class="p">[</span><span class="s1">&#39;m/s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wind_upper</span><span class="o">/</span><span class="mf">3.6</span> <span class="c1">#200/3.6</span>
    <span class="n">upper_wind_limit</span><span class="p">[</span><span class="s1">&#39;mph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wind_upper</span><span class="o">/</span><span class="mf">1.609344</span> <span class="c1">#200/1.609344</span>
    <span class="n">upper_wind_limit</span><span class="p">[</span><span class="s1">&#39;kn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wind_upper</span><span class="o">/</span><span class="mf">1.852</span> <span class="c1">#20/1.852</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_check</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; not in columns. Ignoring this variable name...&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1">#### QUALITY CONTROL 1: REMOVE unrealistic values (outliers)</span>
        <span class="c1">#### Criteria for selecting outliers: Temp &gt; 50ºC or &lt; -50ºC; WindSpeed &gt; 200 km/h.</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;tmean&#39;</span><span class="p">,</span> <span class="s1">&#39;tmin&#39;</span><span class="p">,</span> <span class="s1">&#39;tmax&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper_t_limit</span><span class="p">[</span><span class="n">t_units</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="c1"># Keep only values lower or equal than upper limit</span>
            <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lower_t_limit</span><span class="p">[</span><span class="n">t_units</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;windspeed&#39;</span><span class="p">,</span> <span class="s1">&#39;wspd&#39;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper_wind_limit</span><span class="p">[</span><span class="n">wind_units</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1">#### QUALITY CONTROL 2: REMOVE unrealistic values (above or below 5 times the standard deviation)</span>
        <span class="n">df_std</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">var</span><span class="p">:</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_std&#39;</span><span class="p">})[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_std&#39;</span><span class="p">]</span>
        <span class="n">df_mean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">var</span><span class="p">:</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_mean&#39;</span><span class="p">})[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_mean&#39;</span><span class="p">]</span>

        <span class="n">df_var</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_std</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">])</span>
        <span class="n">df_var</span> <span class="o">=</span> <span class="n">df_var</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_mean</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">])</span>
        <span class="n">df_var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df_var</span><span class="p">[</span><span class="s1">&#39;mean+5std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_var</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">df_var</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_std&#39;</span><span class="p">]</span>
        <span class="n">df_var</span><span class="p">[</span><span class="s1">&#39;mean-5std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_var</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">df_var</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_std&#39;</span><span class="p">]</span>


        <span class="n">df_var</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_var</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_var</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df_var</span><span class="p">[</span><span class="s1">&#39;mean+5std&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_var</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df_var</span><span class="p">[</span><span class="s1">&#39;mean-5std&#39;</span><span class="p">])</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_var</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="compute_climate">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.compute_climate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_climate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">climate_period</span><span class="p">,</span> <span class="n">separate_df</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to compute the climatology of a certain timeseries.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    variables: list</span>
<span class="sd">        List of the variables for which the climatology is going to be computed</span>
<span class="sd">    climate_period: list</span>
<span class="sd">        List of the first and last year of the desired reference climate period</span>
<span class="sd">    separate_df: boolean</span>
<span class="sd">        If true, creates a new DataFrame with the values of the climatology. If false, appends those values to the input DataFrame.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    climate_df: DataFrame</span>
<span class="sd">        Returns a DataFrame with the same data of the input data, but with additional columns representing the climatology of each selected variable</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">##### Step 1. Compute daily climatologies for the period defined by &quot;climate_period&quot;</span>
    <span class="c1">#if df.index.month[-1] != 12 or df.index.month[-1] != 31:</span>
    <span class="c1">#    df = df.reindex(pd.date_range(&#39;%i-01-01&#39; %df.index.year.min(), &#39;%i-12-31&#39; %df.index.year.max(), freq=&#39;1D&#39;))</span>

    <span class="n">climate_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">climate_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">climate_period</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">all_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">daily_statistics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">daily_statistics</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p005&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">climate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">daily_statistics</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">climate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">daily_statistics</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">climate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="n">daily_statistics</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p095&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">climate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)</span>
        <span class="n">daily_statistics</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_mean&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">climate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">daily_statistics</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_median&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">climate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">daily_statistics</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_min&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">climate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">daily_statistics</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_max&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">climate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">daily_statistics</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">climate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="n">all_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">all_stats</span><span class="p">,</span> <span class="n">daily_statistics</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">separate_df</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">climate_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_stats</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">climate_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_stats</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">climate_df</span></div>



<div class="viewcode-block" id="fill_between_colormap">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.fill_between_colormap">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fill_between_colormap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">cmap</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

    <span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>
    <span class="n">yy1</span> <span class="o">=</span> <span class="n">y1</span><span class="o">.</span><span class="n">values</span>
    <span class="n">yy2</span> <span class="o">=</span> <span class="n">y2</span><span class="o">.</span><span class="n">values</span>

    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy1</span> <span class="o">-</span> <span class="n">yy2</span>

    <span class="n">extreme_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">yy</span><span class="p">)),</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">yy</span><span class="p">)))</span>

    <span class="n">normalize</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="n">extreme_value</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">extreme_value</span><span class="p">)</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">([</span><span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span>
                             <span class="p">[</span><span class="n">yy1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">yy1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span>
                             <span class="p">[</span><span class="n">yy2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">yy2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span>
                             <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
                             <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">normalize</span></div>


<div class="viewcode-block" id="compute_daily_records_oneyear">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.compute_daily_records_oneyear">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_daily_records_oneyear</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">year_to_compute</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to compute the exceedances of the extreme values.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    variable: list</span>
<span class="sd">        Variable for which the exceedances are going to be computed</span>
<span class="sd">    year_to_compute: int</span>
<span class="sd">        Year of the data for which the exceedances are going to be computed</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    c: DataFrame</span>
<span class="sd">        Returns a DataFrame the records occurred during &quot;year_to_compute&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="c1">###########################################################################</span>
    <span class="c1">#### COMPUTES DAILY, MONTHLY AND ABSOLUTE RECORDS UP TO &quot;year_to_plot&quot; ####</span>
    <span class="c1">###########################################################################</span>
    <span class="k">if</span> <span class="s1">&#39;Day&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span>
    <span class="k">if</span> <span class="s1">&#39;Month&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>


    <span class="c1"># Compute maximum and minimum values by day, previous to &quot;year_to_plot&quot;</span>
    <span class="n">amax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">amin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="c1"># Compute maximum and minimum values by month, previous to &quot;year_to_plot&quot;</span>
    <span class="n">mmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">mmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="c1"># Compute absolute maximum and minimum valuesprevious to &quot;year_to_plot&quot;</span>
    <span class="n">absmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_to_compute</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">absmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_to_compute</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="n">amax_1</span> <span class="o">=</span> <span class="n">amax</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">mmax_1</span> <span class="o">=</span> <span class="n">mmax</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">amax_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">amax_1</span><span class="p">,</span><span class="n">mmax_1</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">amax_concat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_maxdaily&#39;</span><span class="p">,</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_maxmonthly&#39;</span><span class="p">]</span>
    <span class="n">amax_concat</span> <span class="o">=</span> <span class="n">amax_concat</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])</span>

    <span class="n">amin_1</span> <span class="o">=</span> <span class="n">amin</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">mmin_1</span> <span class="o">=</span> <span class="n">mmin</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">amin_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">amin_1</span><span class="p">,</span><span class="n">mmin_1</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
    <span class="n">amin_concat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_mindaily&#39;</span><span class="p">,</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_minmonthly&#39;</span><span class="p">]</span>
    <span class="n">amin_concat</span> <span class="o">=</span> <span class="n">amin_concat</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])</span>

    <span class="c1"># Current year records</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_compute</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">variable</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="c1">#bmin = df_climate.loc[df.index.year == year_to_plot, [&#39;Month&#39;,&#39;Day&#39;,variable]].groupby([&#39;Month&#39;,&#39;Day&#39;]).min()</span>
    <span class="c1">#c = pd.concat([amax,amin,,bmax,bmin], axis=1)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">amax_concat</span><span class="p">,</span><span class="n">amin_concat</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">29</span><span class="p">))]</span> <span class="c1"># Remove leap day</span>
    <span class="n">c</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_Daymax&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_Monmax&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_Daymin&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_Monmin&#39;</span><span class="p">,</span>
                 <span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span>

    <span class="c1"># Fill columns with daily, monthly and absolute records</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_dayrmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Daymax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">])</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_dayrmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Daymin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">])</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_monrmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Monmax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">])</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_monrmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Monmin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">])</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_absrmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">absmax</span><span class="p">)</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_absrmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">absmin</span><span class="p">)</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_dayrmax_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Daymax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_dayrmin_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Daymin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_monrmax_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Monmax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_monrmin_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Monmin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_absrmax_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">-</span> <span class="n">absmax</span>
    <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_absrmin_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">]</span> <span class="o">-</span> <span class="n">absmin</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;01-01-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;31-12-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_compute</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">dates</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span><span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
    <span class="c1">#c[variable+&#39;_%irecords&#39; %year_to_compute] = c[[variable+&#39;_%idayrmax&#39; %year_to_compute,variable+&#39;_%idayrmin&#39; %year_to_compute]].max(axis=1)</span>
    <span class="c1">#c[variable+&#39;_%irecords_diff&#39; %year_to_compute] = c[[variable+&#39;_%idayrmax_diff&#39; %year_to_compute,variable+&#39;_%idayrmin_diff&#39; %year_to_compute]].max(axis=1)</span>
    <span class="k">return</span> <span class="n">c</span></div>


<div class="viewcode-block" id="compute_daily_records">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.compute_daily_records">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_daily_records</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">years</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to compute the exceedances of the extreme values.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    variable: list</span>
<span class="sd">        Variable for which the exceedances are going to be computed</span>
<span class="sd">    years: list</span>
<span class="sd">        Years of the data for which the exceedances are going to be computed</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    c: DataFrame</span>
<span class="sd">        Returns a DataFrame the records occurred during each year included in &quot;years&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">###########################################################################</span>
    <span class="c1">#### COMPUTES DAILY, MONTHLY AND ABSOLUTE RECORDS UP TO &quot;y&quot; ####</span>
    <span class="c1">###########################################################################</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;Day&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span>
    <span class="k">if</span> <span class="s1">&#39;Month&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>

    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>

        <span class="c1"># Compute maximum and minimum values by day</span>
        <span class="n">amax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">amin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="c1"># Compute maximum and minimum values by month</span>
        <span class="n">mmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">mmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="c1"># Compute absolute maximum and minimum valuesprevious to &quot;y&quot;</span>
        <span class="n">absmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">absmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="n">amax_1</span> <span class="o">=</span> <span class="n">amax</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mmax_1</span> <span class="o">=</span> <span class="n">mmax</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">amax_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">amax_1</span><span class="p">,</span><span class="n">mmax_1</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">amax_concat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_maxdaily&#39;</span><span class="p">,</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_maxmonthly&#39;</span><span class="p">]</span>
        <span class="n">amax_concat</span> <span class="o">=</span> <span class="n">amax_concat</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])</span>

        <span class="n">amin_1</span> <span class="o">=</span> <span class="n">amin</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mmin_1</span> <span class="o">=</span> <span class="n">mmin</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">amin_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">amin_1</span><span class="p">,</span><span class="n">mmin_1</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
        <span class="n">amin_concat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_mindaily&#39;</span><span class="p">,</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_minmonthly&#39;</span><span class="p">]</span>
        <span class="n">amin_concat</span> <span class="o">=</span> <span class="n">amin_concat</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])</span>

        <span class="c1"># Current year records</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">variable</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">amax_concat</span><span class="p">,</span><span class="n">amin_concat</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">29</span><span class="p">))]</span> <span class="c1"># Remove leap day</span>
        <span class="n">c</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_Daymax&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_Monmax&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_Daymin&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_Monmin&#39;</span><span class="p">,</span>
                     <span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span>

        <span class="c1"># Fill columns with daily, monthly and absolute records</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_dayrmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Daymax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">])</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_dayrmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Daymin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">])</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_monrmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Monmax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">])</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_monrmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Monmin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">])</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_absrmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">absmax</span><span class="p">)</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_absrmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">absmin</span><span class="p">)</span>

        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_dayrmax_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Daymax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_dayrmin_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Daymin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_monrmax_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Monmax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_monrmin_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_Monmin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_absrmax_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">absmax</span>
        <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_absrmin_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">variable</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">absmin</span>


        <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;01-01-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;31-12-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">y</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">dates</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span><span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">c1</span><span class="p">,</span><span class="n">c</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">c1</span><span class="p">,</span><span class="n">c</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">c1</span></div>


<div class="viewcode-block" id="plot_records_count">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_records_count">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_records_count</span><span class="p">(</span><span class="n">records_df</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">freq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;freq&#39; must be &#39;day&#39;, &#39;month&#39; or &#39;year&#39;. Your &#39;freq&#39; is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span><span class="n">freq</span><span class="p">)</span>

    <span class="n">var</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">title_var</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">var</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;day&#39;</span>
    <span class="n">var</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mon&#39;</span>
    <span class="n">var</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;abs&#39;</span>

    <span class="n">title_var</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Daily&#39;</span>
    <span class="n">title_var</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Monthly&#39;</span>
    <span class="n">title_var</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Annual&#39;</span>

    <span class="n">records_df</span> <span class="o">=</span> <span class="n">records_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">records_df</span> <span class="o">=</span> <span class="n">records_df</span><span class="p">[[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">rmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">var</span><span class="p">[</span><span class="n">freq</span><span class="p">]),</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">rmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">var</span><span class="p">[</span><span class="n">freq</span><span class="p">])]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>



    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="c1"># plot the same data on both axes</span>
    <span class="n">records_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">rmax&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">var</span><span class="p">[</span><span class="n">freq</span><span class="p">]):</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">rmin&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">var</span><span class="p">[</span><span class="n">freq</span><span class="p">]):</span> <span class="s1">&#39;blue&#39;</span><span class="p">},</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency (days)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Number of days above previous high record&#39;</span><span class="p">,</span> <span class="s1">&#39;Number of days below previous low record&#39;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.915</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.915</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> records for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">title_var</span><span class="p">[</span><span class="n">freq</span><span class="p">],</span> <span class="n">variable</span><span class="p">,</span> <span class="n">station_name</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.93</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>




<div class="viewcode-block" id="compute_and_plot_exceedances">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.compute_and_plot_exceedances">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_and_plot_exceedances</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_scale</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">upwards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_means</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">averaging_period</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alldatamean</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to compute the number of times a threshold value has been exceeded.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    variable: str</span>
<span class="sd">        Variable to be analysed</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    threshold: int or float</span>
<span class="sd">        Threshold value</span>
<span class="sd">    time_scale: str</span>
<span class="sd">        Time scale to which aggregate the number of exceedances</span>
<span class="sd">    upwards: str</span>
<span class="sd">        If True, computes exceedances above the threshold value. If False, computes exceedances below the threshold value</span>
<span class="sd">    plot_means: boolean</span>
<span class="sd">        If True, plots mean values, grouped each &quot;averaging_period&quot; periods (see next description).</span>
<span class="sd">    averaging_period: int</span>
<span class="sd">        The length of the grouping periods used to plot period averages.</span>
<span class="sd">    alldatamean: boolean</span>
<span class="sd">        If True, and plot_means also True, it plots a line representing the mean value of all available data.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>


    <span class="k">if</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">upwards</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">exceedances</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>

            <span class="n">exceedances</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">exceedances</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>

            <span class="n">exceedances</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>


        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="p">,</span> <span class="n">exceedances</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#00ad5c&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_means</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)</span> <span class="o">%</span> <span class="n">averaging_period</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">averaging_period</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">exceedances</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period mean&#39;</span> <span class="o">%</span><span class="n">averaging_period</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">exceedances</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">),</span><span class="n">averaging_period</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">exceedances</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period mean&#39;</span> <span class="o">%</span><span class="n">averaging_period</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">exceedances</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceedances</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">alldatamean</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">exceedances</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xmax</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Year</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#FF0000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean of all values&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_means</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;exceedances&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.935</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.965</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Annual exceedances of </span><span class="si">%s</span><span class="s1">=%1.f&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">threshold</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.97</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>



    <span class="k">elif</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;season&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">upwards</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">exceedances</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
            <span class="c1"># Group to season</span>
            <span class="n">month_to_season_lu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;DJF&#39;</span><span class="p">,</span> <span class="s1">&#39;DJF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span>
                <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span>
                <span class="s1">&#39;DJF&#39;</span>
            <span class="p">])</span>
            <span class="n">grp_ary</span> <span class="o">=</span> <span class="n">month_to_season_lu</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp_ary</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>

            <span class="n">exceedances</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;season&#39;</span><span class="p">,</span><span class="s1">&#39;Year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">exceedances</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
            <span class="c1"># Group to season</span>
            <span class="n">month_to_season_lu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;DJF&#39;</span><span class="p">,</span> <span class="s1">&#39;DJF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span>
                <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span>
                <span class="s1">&#39;DJF&#39;</span>
            <span class="p">])</span>
            <span class="n">grp_ary</span> <span class="o">=</span> <span class="n">month_to_season_lu</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp_ary</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>

            <span class="n">exceedances</span><span class="o">=</span><span class="n">exceedances</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;season&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">season_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;December-January-February&#39;</span><span class="p">,</span> <span class="s1">&#39;March-April-May&#39;</span><span class="p">,</span> <span class="s1">&#39;June-July-August&#39;</span><span class="p">,</span> <span class="s1">&#39;September-October-November&#39;</span><span class="p">]</span><span class="c1"># [&#39;DJF&#39;, &#39;MAM&#39;, &#39;JJA&#39;, &#39;SON&#39;]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">exceedances</span><span class="p">[</span><span class="n">exceedances</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#00ad5c&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_means</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span> <span class="o">%</span> <span class="n">averaging_period</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">averaging_period</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period mean&#39;</span> <span class="o">%</span><span class="n">averaging_period</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">),</span><span class="n">averaging_period</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period mean&#39;</span> <span class="o">%</span><span class="n">averaging_period</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">alldatamean</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#FF0000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean of all values&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">season_names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_means</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1">#    ax[3].legend(fontsize=14,ncol=2)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.03</span><span class="p">,</span><span class="o">-</span><span class="mf">0.22</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#, transform=plt.gcf().transFigure)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;exceedances&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;exceedances&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.18</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.12</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Seasonal exceedances of </span><span class="si">%s</span><span class="s1">=%1.f&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">threshold</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">upwards</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">exceedances</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>

            <span class="n">exceedances</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">exceedances</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
            <span class="n">exceedances</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>

            <span class="n">exceedances</span> <span class="o">=</span> <span class="n">exceedances</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>


        <span class="n">month_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;January&#39;</span><span class="p">,</span> <span class="s1">&#39;February&#39;</span><span class="p">,</span> <span class="s1">&#39;March&#39;</span><span class="p">,</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;June&#39;</span><span class="p">,</span> <span class="s1">&#39;July&#39;</span><span class="p">,</span> <span class="s1">&#39;August&#39;</span><span class="p">,</span> <span class="s1">&#39;September&#39;</span><span class="p">,</span> <span class="s1">&#39;October&#39;</span><span class="p">,</span> <span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="s1">&#39;December&#39;</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">16.5</span><span class="p">,</span><span class="mf">11.5</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">):</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">exceedances</span><span class="p">[</span><span class="n">exceedances</span><span class="o">.</span><span class="n">Month</span> <span class="o">==</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#00ad5c&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_means</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span> <span class="o">%</span> <span class="n">averaging_period</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">averaging_period</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period mean&#39;</span> <span class="o">%</span><span class="n">averaging_period</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">),</span><span class="n">averaging_period</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period mean&#39;</span> <span class="o">%</span><span class="n">averaging_period</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)),</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plot</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">alldatamean</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">Year</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#FF0000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean of all values&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">month_names</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_means</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1">#    ax[11].legend(fontsize=14,ncol=2)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.38</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">.102</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#, transform=plt.gcf().transFigure)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;exceedances&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;exceedances&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;exceedances&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;exceedances&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.91</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.13</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Monthly exceedances of </span><span class="si">%s</span><span class="s1">=%1.f&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">threshold</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_variable_trends">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_variable_trends">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_variable_trends</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">averaging_period</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">grouping</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">grouping_stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">rain_limit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot_kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">alldatamean</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot and compare the annual meteogram of a certain year (year_to_plot) with the climatological normal</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    var: str</span>
<span class="sd">        Name of the variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    averaging_period: int</span>
<span class="sd">        The window for the averaging process</span>
<span class="sd">    grouping: str</span>
<span class="sd">        The time scale into which the data is going to be grouped</span>
<span class="sd">    grouping_stat: str</span>
<span class="sd">        The statistic for data grouping</span>
<span class="sd">    plot_kind: str</span>
<span class="sd">        Desired plot type (line or bar)</span>
<span class="sd">    alldatamean: boolean</span>
<span class="sd">        If True, plots the mean value of all available data</span>
<span class="sd">   &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>


    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;days&#39;</span><span class="p">:</span>
        <span class="c1"># Set a limit on rainfall for computing rainy days</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Rainfall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Rainfall&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rain_limit</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">grouping</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;AS&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">grouping_stat</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#008b4a&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#008b4a&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1">#if len(df) % averaging_period == 1:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">averaging_period</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),:][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period mean&#39;</span> <span class="o">%</span><span class="n">averaging_period</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),:][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">alldatamean</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#FF0000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean of all values&#39;</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.185</span><span class="p">),</span>
                        <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.031</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="c1">#plt.suptitle(&#39;%s evolution and %i-period mean&#39; %(var, averaging_period), fontsize=22, y=0.97)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> evolution&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.97</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.075</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.87</span><span class="p">)</span>
        <span class="c1">#fig.autofmt_xdate()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">1.08</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">grouping</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;season&#39;</span><span class="p">:</span>
        <span class="c1"># Group to season</span>
        <span class="n">month_to_season_lu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;DJF&#39;</span><span class="p">,</span> <span class="s1">&#39;DJF&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span>
            <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span>
            <span class="s1">&#39;DJF&#39;</span>
        <span class="p">])</span>
        <span class="n">grp_ary</span> <span class="o">=</span> <span class="n">month_to_season_lu</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp_ary</span>
        <span class="n">df_winter</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="s1">&#39;DJF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">grouping_stat</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_spring</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="s1">&#39;MAM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">grouping_stat</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_summer</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="s1">&#39;JJA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">grouping_stat</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_autumn</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="s1">&#39;SON&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">grouping_stat</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_winter</span><span class="p">,</span> <span class="n">df_spring</span><span class="p">,</span> <span class="n">df_summer</span><span class="p">,</span> <span class="n">df_autumn</span><span class="p">]</span>


        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">15.75</span><span class="p">,</span><span class="mf">8.75</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">plot_kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#008b4a&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#008b4a&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="c1">#if len(df_list[j]) % averaging_period == 1:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">averaging_period</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])),:][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period mean&#39;</span> <span class="o">%</span><span class="n">averaging_period</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])),:][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">alldatamean</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#FF0000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean of all values&#39;</span><span class="p">)</span>


            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">([</span><span class="s1">&#39;December-January-February&#39;</span><span class="p">,</span> <span class="s1">&#39;March-April-May&#39;</span><span class="p">,</span> <span class="s1">&#39;June-July-August&#39;</span><span class="p">,</span> <span class="s1">&#39;September-October-November&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="c1">#ax[0].legend(fontsize=14, ncol=2)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.18</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">.102</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="c1">#, loc=&#39;lower center&#39;) #, transform=plt.gcf().transFigure)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.965</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.965</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.937</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>

        <span class="c1">#plt.suptitle(&#39;%s evolution and %i-period mean&#39; %(var, averaging_period), fontsize=22, y=0.98)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> evolution&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
        <span class="c1">#plt.subplots_adjust(left=0.05, right=0.95, hspace=0.15, wspace=0.15,bottom=0.05, top=0.9)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.095</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.13</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">grouping</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span>
        <span class="n">df_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">month_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;January&#39;</span><span class="p">,</span> <span class="s1">&#39;February&#39;</span><span class="p">,</span> <span class="s1">&#39;March&#39;</span><span class="p">,</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;June&#39;</span><span class="p">,</span> <span class="s1">&#39;July&#39;</span><span class="p">,</span> <span class="s1">&#39;August&#39;</span><span class="p">,</span> <span class="s1">&#39;September&#39;</span><span class="p">,</span> <span class="s1">&#39;October&#39;</span><span class="p">,</span> <span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="s1">&#39;December&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">):</span>
            <span class="n">df_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">grouping_stat</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">16.25</span><span class="p">,</span><span class="mf">10.5</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">plot_kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#008b4a&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#008b4a&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="c1">#if len(df_list[j]) % averaging_period == 1:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">averaging_period</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])),:][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period mean&#39;</span> <span class="o">%</span><span class="n">averaging_period</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])),:][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">averaging_period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">alldatamean</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">xmin</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xmax</span><span class="o">=</span><span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#FF0000&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean of all values&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">month_names</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">]:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.44</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">.102</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#, transform=plt.gcf().transFigure)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.9675</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9675</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;cm&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">grouping_stat</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">]:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> evolution [</span><span class="si">%s</span><span class="s1">/day]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.97</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> evolution [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.97</span><span class="p">)</span>

<span class="c1">#        plt.suptitle(&#39;%s evolution [%s] and %i-period mean&#39; %(var, units, averaging_period), fontsize=20, y=0.97)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.975</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.135</span><span class="p">,</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.095</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>


<span class="c1">#        ax[10].legend(fontsize=14, ncol=3, bbox_to_anchor=(0., -.47, 1., .102), loc=&#39;lower center&#39;)</span>
<span class="c1">#        print([l for l in ax[10].get_lines()])</span>
<span class="c1">#        labels = [str(line.get_label()) for line in ax[10].get_lines()]</span>
<span class="c1">#        print(labels)</span>
        <span class="c1">#fig.legend( [l for l in ax[10].get_lines()], loc=&#39;lower right&#39;, bbox_to_anchor=(1,-0.1), ncol=2, bbox_transform=fig.transFigure)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_data_vs_climate">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_data_vs_climate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_data_vs_climate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">df_climate</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">units</span><span class="p">,</span><span class="n">inidate</span><span class="p">,</span><span class="n">enddate</span><span class="p">,</span><span class="n">colormap</span><span class="p">,</span><span class="n">database</span><span class="p">,</span><span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">climate_stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">fillcolor_gradient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_seasons</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot climatological data against the climatological mean or median of one variable.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    df_climate: DataFrame</span>
<span class="sd">        DataFrame containing the climatological data</span>
<span class="sd">    variable: str</span>
<span class="sd">        Variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    inidate: datetime.datetime</span>
<span class="sd">        First date to be plotted</span>
<span class="sd">    enddate: datetime.datetime</span>
<span class="sd">        Last date to be plotted</span>
<span class="sd">    colormap: matplotlib colormap</span>
<span class="sd">        Colormap to be used in plotting</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    kind: str</span>
<span class="sd">        Kind of plot (line or bar)</span>
<span class="sd">    climate_stat: str</span>
<span class="sd">        Metric to compute the climatological normal values (mean or median)</span>
<span class="sd">    fillcolor_gradient: boolean</span>
<span class="sd">        Parameter that controls the way the colormap is employed. If true, the colormap is continue</span>
<span class="sd">    use_std : boolean</span>
<span class="sd">        If True, use the std of the data for shading. Else, it uses the 10th and 90th percentiles. Only works if show_bands=True</span>
<span class="sd">    show_bands: boolean</span>
<span class="sd">        If True, shows bands representing the standard deviation or the range of percentiles 10th to 90th</span>
<span class="sd">    show_seasons: boolean</span>
<span class="sd">        If true, the background is plotted with different colors for each climatological season    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>


    <span class="k">if</span> <span class="n">climate_stat</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;climate_stat&quot; should be equal to &quot;median&quot; or &quot;mean&quot;&#39;</span><span class="p">)</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">MonthLocator</span><span class="p">()</span> <span class="c1">#minticks=3, maxticks=12)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#47fe60&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p095&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p005&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;5</span><span class="si">%-95%</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fillcolor_gradient</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">where</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">climate_stat</span><span class="p">)],</span><span class="n">where</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fill_between_colormap</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_bands</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_std</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span>
                                <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span>  <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;+-1std&quot;</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>
        <span class="n">diff_var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="o">-</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_bands</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_std</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span>
                                <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span>  <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;+-1std&quot;</span><span class="p">)</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;kind must be &quot;line&quot; or &quot;bar&quot;.&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daily </span><span class="si">%s</span><span class="s1"> during period: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.095</span><span class="p">),</span>
                           <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.0425</span><span class="p">,</span> <span class="s1">&#39;Period min.: </span><span class="si">%.2f%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">units</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.0425</span><span class="p">,</span> <span class="s1">&#39;Period max.: </span><span class="si">%.2f%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">units</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
<span class="c1">#    fig.autofmt_xdate()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">inidate</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">enddate</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>

    <span class="c1"># Show seasons</span>
    <span class="k">if</span> <span class="n">show_seasons</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">season_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="s1">&#39;#32a852&#39;</span><span class="p">,</span> <span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="s1">&#39;#d6db46&#39;</span><span class="p">,</span> <span class="s2">&quot;#4696db&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#32a852&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#d6db46&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span> <span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_data_vs_climate_withrecords">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_data_vs_climate_withrecords">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_data_vs_climate_withrecords</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">df_climate</span><span class="p">,</span><span class="n">records_df</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">units</span><span class="p">,</span><span class="n">inidate</span><span class="p">,</span><span class="n">enddate</span><span class="p">,</span><span class="n">colormap</span><span class="p">,</span><span class="n">database</span><span class="p">,</span><span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">climate_stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">fillcolor_gradient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_bands</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">show_seasons</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot climatological data against the climatological mean or median of one variable, and shows when a record value has been broken.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    df_climate: DataFrame</span>
<span class="sd">        DataFrame containing the climatological data</span>
<span class="sd">    records_df: DataFrame</span>
<span class="sd">        DataFrame containing the records values</span>
<span class="sd">    variable: str</span>
<span class="sd">        Variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    inidate: datetime.datetime</span>
<span class="sd">        First date to be plotted</span>
<span class="sd">    enddate: datetime.datetime</span>
<span class="sd">        Last date to be plotted</span>
<span class="sd">    colormap: matplotlib colormap</span>
<span class="sd">        Colormap to be used in plotting</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    kind: str</span>
<span class="sd">        Kind of plot (line or bar)</span>
<span class="sd">    climate_stat: str</span>
<span class="sd">        Metric to compute the climatological normal values (mean or median)</span>
<span class="sd">    fillcolor_gradient: boolean</span>
<span class="sd">        Parameter that controls the way the colormap is employed. If true, the colormap is continue</span>
<span class="sd">    use_std : boolean</span>
<span class="sd">        If True, use the std of the data for shading. Else, it uses the 10th and 90th percentiles. Only works if show_bands=True</span>
<span class="sd">    show_bands: boolean</span>
<span class="sd">        If True, shows bands representing the standard deviation or the range of percentiles 10th to 90th</span>
<span class="sd">    show_seasons: boolean</span>
<span class="sd">        If true, the background is plotted with different colors for each climatological season    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>


    <span class="k">if</span> <span class="n">climate_stat</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;climate_stat&quot; should be equal to &quot;median&quot; or &quot;mean&quot;&#39;</span><span class="p">)</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">MonthLocator</span><span class="p">()</span> <span class="c1">#minticks=3, maxticks=12)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">median</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>
        <span class="c1">#ax.fill_between(df_climate.loc[inidate:enddate, &#39;%s_%s&#39; %(variable, climate_stat)].index,df_climate.loc[inidate:enddate,&#39;%s_p090&#39; %variable],df_climate.loc[inidate:enddate,&#39;%s_p010&#39; %variable],color=&#39;grey&#39;,alpha=0.4,label=&quot;10%-90%&quot;)</span>
        <span class="c1">#ax.fill_between(df_climate.loc[inidate:enddate, &#39;%s_%s&#39; %(variable, climate_stat)].index,df_climate.loc[inidate:enddate,&#39;%s_p095&#39; %variable],df_climate.loc[inidate:enddate,&#39;%s_p005&#39; %variable],color=&#39;grey&#39;,alpha=0.25,label=&quot;5%-95%&quot;)</span>
        <span class="k">if</span> <span class="n">fillcolor_gradient</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">where</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">where</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fill_between_colormap</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_bands</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_std</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span>
                                <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span>  <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;+-1std&quot;</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
        <span class="n">median</span><span class="p">,</span><span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>
        <span class="n">diff_var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span>
        <span class="c1">#print(diff_var)</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="o">-</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_bands</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_std</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span>
                                <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">)]</span>  <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;+-1std&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;kind must be &quot;line&quot; or &quot;bar&quot;.&#39;</span><span class="p">)</span>

    <span class="c1"># Daily records</span>
    <span class="n">records_df</span> <span class="o">=</span> <span class="n">records_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,:]</span>
    <span class="n">drmax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="n">drmin</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="c1"># Monthly records</span>
    <span class="n">mrmax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above monthly high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="n">mrmin</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below monthly low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="c1"># Absolute records</span>
    <span class="n">absrmax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above absolute high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="n">absrmin</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below absolute low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">)]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>


    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daily </span><span class="si">%s</span><span class="s1"> during period: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.0425</span><span class="p">,</span> <span class="s1">&#39;Period min.: </span><span class="si">%.2f%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">units</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.0425</span><span class="p">,</span> <span class="s1">&#39;Period max.: </span><span class="si">%.2f%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">units</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>

    <span class="c1"># Legends</span>
    <span class="c1"># Create a legend for the median.</span>
    <span class="k">if</span> <span class="n">show_bands</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">first_legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">first_legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">median</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>

    <span class="c1"># Add the legend manually to the Axes.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">first_legend</span><span class="p">)</span>

    <span class="c1"># Create another legend for the records.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">drmax</span><span class="p">,</span> <span class="n">drmin</span><span class="p">,</span> <span class="n">mrmax</span><span class="p">,</span> <span class="n">mrmin</span><span class="p">,</span> <span class="n">absrmax</span><span class="p">,</span> <span class="n">absrmin</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">inidate</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">enddate</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.095</span><span class="p">),</span>
                           <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># Show seasons</span>
    <span class="k">if</span> <span class="n">show_seasons</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">season_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="s1">&#39;#32a852&#39;</span><span class="p">,</span> <span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="s1">&#39;#d6db46&#39;</span><span class="p">,</span> <span class="s2">&quot;#4696db&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#32a852&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#d6db46&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.915</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span> <span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.915</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_data_vs_climate_withrecords_multivar">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_data_vs_climate_withrecords_multivar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_data_vs_climate_withrecords_multivar</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">df_climate</span><span class="p">,</span><span class="n">records_df</span><span class="p">,</span><span class="n">vars_list</span><span class="p">,</span><span class="n">units_list</span><span class="p">,</span><span class="n">inidate</span><span class="p">,</span><span class="n">enddate</span><span class="p">,</span><span class="n">colormap</span><span class="p">,</span><span class="n">database</span><span class="p">,</span><span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">climate_stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">fillcolor_gradient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_seasons</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot climatological data of up to two variables against the climatological mean or median, and shows when a record value has been broken.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    df_climate: DataFrame</span>
<span class="sd">        DataFrame containing the climatological data</span>
<span class="sd">    records_df: DataFrame</span>
<span class="sd">        DataFrame containing the records values</span>
<span class="sd">    vars_list: str</span>
<span class="sd">        Variable(s) to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable(s) to be plotted</span>
<span class="sd">    inidate: datetime.datetime</span>
<span class="sd">        First date to be plotted</span>
<span class="sd">    enddate: datetime.datetime</span>
<span class="sd">        Last date to be plotted</span>
<span class="sd">    colormap: matplotlib colormap</span>
<span class="sd">        Colormap to be used in plotting</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    kind: str</span>
<span class="sd">        Kind of plot (line or bar)</span>
<span class="sd">    climate_stat: str</span>
<span class="sd">        Metric to compute the climatological normal values (mean or median)</span>
<span class="sd">    fillcolor_gradient: boolean</span>
<span class="sd">        Parameter that controls the way the colormap is employed. If true, the colormap is continue</span>
<span class="sd">    use_std : boolean</span>
<span class="sd">        If True, use the std of the data for shading. Else, it uses the 10th and 90th percentiles. Only works if show_bands=True</span>
<span class="sd">    show_bands: boolean</span>
<span class="sd">        If True, shows bands representing the standard deviation or the range of percentiles 10th to 90th</span>
<span class="sd">    show_seasons: boolean</span>
<span class="sd">        If true, the background is plotted with different colors for each climatological season    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(vars_list) must be greater or equal than 2. Your vars_list has a length of: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Your vars_list has a length of </span><span class="si">%i</span><span class="s1">, but only the two first elements will be read.&#39;</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">climate_stat</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;climate_stat&quot; should be equal to &quot;median&quot; or &quot;mean&quot;&#39;</span><span class="p">)</span>


    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>


    <span class="n">records_df</span> <span class="o">=</span> <span class="n">records_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">records_df</span> <span class="o">=</span> <span class="n">records_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,:]</span>

    <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">MonthLocator</span><span class="p">()</span> <span class="c1">#minticks=3, maxticks=12)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>
        <span class="n">median</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fillcolor_gradient</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">where</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">where</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fill_between_colormap</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_bands</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_std</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>  <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;+-1std&quot;</span><span class="p">)</span>

        <span class="c1"># Daily records</span>
        <span class="n">drmax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">drmin</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Monthly records</span>
        <span class="n">mrmax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above monthly high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
        <span class="n">mrmin</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below monthly low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
        <span class="c1"># Absolute records</span>
        <span class="n">absrmax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above absolute high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>
        <span class="n">absrmin</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below absolute low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

        <span class="c1"># Second variable</span>
        <span class="k">if</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Rainfall&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">median1</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#47fe60&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1">#ax[1].fill_between(df_climate.loc[inidate:enddate, &#39;%s_p095&#39;].index,df_climate.loc[inidate:enddate,&#39;%s_p095&#39; %vars_list[1]],df_climate.loc[inidate:enddate,&#39;%s_p005&#39; %vars_list[1]],color=&#39;grey&#39;,alpha=0.25,label=&quot;5%-95%&quot;)</span>
            <span class="k">if</span> <span class="n">fillcolor_gradient</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">where</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">where</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fill_between_colormap</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff_var1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>
            <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var1</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var1</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">mask3</span> <span class="o">=</span> <span class="n">diff_var1</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#32a852&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#996100&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask3</span><span class="p">[</span><span class="n">mask3</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask3</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Daily records</span>
        <span class="n">drmax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">drmin1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Monthly records</span>
        <span class="n">mrmax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above monthly high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
        <span class="n">mrmin1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below monthly low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
        <span class="c1"># Absolute records</span>
        <span class="n">absrmax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above absolute high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>
        <span class="n">absrmin1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below absolute low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
        <span class="n">median</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>
        <span class="n">diff_var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>
        <span class="c1">#print(diff_var)</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="o">-</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_bands</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_std</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>  <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_std&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;+-1std&quot;</span><span class="p">)</span>

        <span class="c1"># Daily records</span>
        <span class="n">drmax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">drmin</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="c1"># Monthly records</span>
        <span class="n">mrmax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above monthly high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">mrmin</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below monthly low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="c1"># Absolute records</span>
        <span class="n">absrmax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above absolute high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">absrmin</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below absolute low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>


        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Rainfall&#39;</span><span class="p">:</span>
            <span class="n">median1</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#47fe60&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>
<span class="c1">#            median1, = ax[1].plot(df_climate.loc[inidate:enddate, vars_list[1]].index, df_climate.loc[inidate:enddate,&#39;%s_%s&#39; %(vars_list[1], climate_stat)],color=&quot;#47fe60&quot;,label=&#39;Climate %s&#39; %climate_stat)</span>
            <span class="n">diff_var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>
            <span class="c1">#print(diff_var)</span>
            <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="o">-</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff_var1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>
            <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var1</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var1</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">mask3</span> <span class="o">=</span> <span class="n">diff_var1</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#32a852&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#996100&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask3</span><span class="p">[</span><span class="n">mask3</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask3</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="c1"># Daily records</span>
        <span class="n">drmax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">drmin1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days with low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_dayrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="c1"># Monthly records</span>
        <span class="n">mrmax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above monthly high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">mrmin1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below monthly low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_monrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="c1"># Absolute records</span>
        <span class="n">absrmax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days above absolute high record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmax&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">absrmin1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">records_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Days below absolute low record: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">records_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_absrmin&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>


        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;kind must be &quot;line&quot; or &quot;bar&quot;.&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> during period </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inidate</span><span class="p">:</span><span class="n">enddate</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">)),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1"># Legends</span>
    <span class="c1"># Create a legend for the median.</span>
    <span class="k">if</span> <span class="n">show_bands</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">first_legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">first_legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">median</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>


    <span class="c1"># Add the legend manually to the Axes.</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">first_legend</span><span class="p">)</span>

    <span class="c1"># Create another legend for the records.</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">drmax</span><span class="p">,</span> <span class="n">drmin</span><span class="p">,</span> <span class="n">mrmax</span><span class="p">,</span> <span class="n">mrmin</span><span class="p">,</span> <span class="n">absrmax</span><span class="p">,</span> <span class="n">absrmin</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1">#ax[0].legend(loc=&#39;upper center&#39;,ncol=4).set_visible(True)</span>
    <span class="k">if</span> <span class="n">vars_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Rainfall&#39;</span><span class="p">:</span>
        <span class="c1"># Create a legend for the median.</span>
        <span class="n">first_legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">median1</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
        <span class="c1"># Add the legend manually to the Axes.</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">first_legend</span><span class="p">)</span>

        <span class="c1"># Create another legend for the records.</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">drmax1</span><span class="p">,</span> <span class="n">drmin1</span><span class="p">,</span> <span class="n">mrmax1</span><span class="p">,</span> <span class="n">mrmin1</span><span class="p">,</span> <span class="n">absrmax1</span><span class="p">,</span> <span class="n">absrmin1</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.185</span><span class="p">),</span>
                           <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">inidate</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">enddate</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">inidate</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">enddate</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>

    <span class="c1"># Show seasons</span>
    <span class="k">if</span> <span class="n">show_seasons</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">season_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="s1">&#39;#32a852&#39;</span><span class="p">,</span> <span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="s1">&#39;#d6db46&#39;</span><span class="p">,</span> <span class="s2">&quot;#4696db&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#32a852&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#d6db46&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.915</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.915</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>




<div class="viewcode-block" id="plot_periodaverages">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_periodaverages">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_periodaverages</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_climate</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">inidate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">plotdir</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">use_std</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot a timeseries of the mean (or median) value of a variable within a defined period. It also plots a moving average with a period defined by the parameter &quot;window&quot;.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df : DataFrame</span>
<span class="sd">        DataFrame with all data of the days to be analysed</span>
<span class="sd">    df_climate : DataFrame</span>
<span class="sd">        DataFrame with annual averages of all data of the days to be analysed</span>
<span class="sd">    var : str</span>
<span class="sd">        Variable to plot</span>
<span class="sd">    units : str</span>
<span class="sd">        Units of the variable to plot</span>
<span class="sd">    inidate: datetime.datetime</span>
<span class="sd">        First date to be selected (only day and month are used, unless month of enddate is lower than month of inidate)</span>
<span class="sd">    enddate: datetime.datetime</span>
<span class="sd">        Last date to be selected (only day and month are used, unless month of enddate is lower than month of inidate)</span>
<span class="sd">    station_name : str</span>
<span class="sd">        Location of the data</span>
<span class="sd">    database : str</span>
<span class="sd">        Source of the data</span>
<span class="sd">    plotdir : str</span>
<span class="sd">        Plotting directory</span>
<span class="sd">    stat : str</span>
<span class="sd">        Statistic to apply to the data</span>
<span class="sd">    window : int</span>
<span class="sd">        Window of the moving average</span>
<span class="sd">    use_std : boolean</span>
<span class="sd">        If True, use the std of the data for shading. Else, it uses the 5th, 10th, 90th and 95th percentiles</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span>  <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>


    <span class="k">if</span> <span class="s1">&#39;Year&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
    <span class="k">if</span> <span class="s1">&#39;Year&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df_climate</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>


    <span class="c1">### Visualizador de datos de un periodo concreto</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;to_select_dates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span>

    <span class="n">first_selected_day</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="n">inidate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">&amp;</span>
                                                 <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">inidate</span><span class="o">.</span><span class="n">month</span><span class="p">)]</span>

    <span class="n">last_selected_day</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="n">enddate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">&amp;</span>
                                                 <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">enddate</span><span class="o">.</span><span class="n">month</span><span class="p">)]</span>
    <span class="n">selected_dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_selected_day</span><span class="p">)):</span>
        <span class="n">selected_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">first_selected_day</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">last_selected_day</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">selected_dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">selected_dates</span><span class="p">)</span>

    <span class="c1"># Los datos de los días seleccionados</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_dates</span><span class="p">)]</span>
    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_dates</span><span class="p">)]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-year MA&#39;</span> <span class="o">%</span><span class="n">window</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind</span><span class="o">==</span><span class="s1">&#39;line&#39;</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;pink&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">clip_on</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">var</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">clip_on</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">: </span><span class="si">%.1f</span><span class="s1">ºC&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">var</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#47fe60&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median: </span><span class="si">%.1f%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">units</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#        ax.plot(df_climate.index, np.tile(df_climate[var+&#39;_%s&#39; %stat].median(),len(df_climate)),color=&quot;#47fe60&quot;,label=&#39;Median: %.1f%s&#39; %(df_climate[var+&#39;_%s&#39; %stat].median(), units), zorder=2)</span>
        <span class="k">if</span> <span class="n">use_std</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.90</span><span class="p">)[</span><span class="n">var</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.10</span><span class="p">)[</span><span class="n">var</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)[</span><span class="n">var</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)[</span><span class="n">var</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;5</span><span class="si">%-95%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.90</span><span class="p">)[</span><span class="n">var</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.10</span><span class="p">)[</span><span class="n">var</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;+-1std&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ff4444&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#0E6FFF&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Record min.: </span><span class="si">%.1f%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; [</span><span class="si">%.0f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Record max.: </span><span class="si">%.1f%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; [</span><span class="si">%.0f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">units</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">. Reference period: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span>
                  <span class="o">%</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">inidate</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b&#39;</span><span class="p">),</span>
                    <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">enddate</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b&#39;</span><span class="p">)),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">),</span><span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.135</span><span class="p">),</span>
                           <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.935</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.905</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.5</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotdir</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">averageofperiod.png&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>



<span class="c1">#def plot_movingaverages(df,df_climate):</span>



<div class="viewcode-block" id="plot_data_and_accum_anoms">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_data_and_accum_anoms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_data_and_accum_anoms</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">df_climate</span><span class="p">,</span><span class="n">year_to_plot</span><span class="p">,</span><span class="n">vars_list</span><span class="p">,</span><span class="n">units_list</span><span class="p">,</span><span class="n">colormap</span><span class="p">,</span><span class="n">database</span><span class="p">,</span><span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">plotdir</span><span class="p">,</span> <span class="n">climate_stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">secondplot_type</span><span class="o">=</span><span class="s1">&#39;accum&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">show_seasons</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot climatological data of one variable against the climatological mean or median, and their cumulative or moving mean.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    df_climate: DataFrame</span>
<span class="sd">        DataFrame containing the climatological data</span>
<span class="sd">    year_to_plot: int</span>
<span class="sd">        Year of the data to be plotted</span>
<span class="sd">    vars_list: str</span>
<span class="sd">        Variable(s) to be plotted</span>
<span class="sd">    units_list: str</span>
<span class="sd">        Units of the variable(s) to be plotted</span>
<span class="sd">    inidate: datetime.datetime</span>
<span class="sd">        First date to be plotted</span>
<span class="sd">    enddate: datetime.datetime</span>
<span class="sd">        Last date to be plotted</span>
<span class="sd">    colormap: matplotlib colormap</span>
<span class="sd">        Colormap to be used in plotting</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    plotdir: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    climate_stat: str</span>
<span class="sd">        Metric to compute the climatological normal values (mean or median)</span>
<span class="sd">    secondplot_type: str</span>
<span class="sd">        Type of the second plot (accum or moving)</span>
<span class="sd">    show_seasons: boolean</span>
<span class="sd">        If true, the background is plotted with different colors for each climatological season    </span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(vars_list) must be greater or equal than 1. Your vars_list has a length of: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">secondplot_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;accum&#39;</span><span class="p">,</span><span class="s1">&#39;moving&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;anom_type&quot; must be either &quot;accum&quot; or &quot;moving&quot;.&#39;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">]</span>
    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-01-01&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-12-31&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">:</span>
        <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-01-01&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-12-31&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">))</span>


    <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">MonthLocator</span><span class="p">()</span> <span class="c1">#minticks=3, maxticks=12)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">)):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">median</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>
        <span class="n">diff_var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="o">-</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>


        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

        <span class="c1"># Accumulated anoms or MA anoms</span>
        <span class="n">anoms_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">secondplot_type</span> <span class="o">==</span> <span class="s1">&#39;accum&#39;</span><span class="p">:</span>
            <span class="n">accum_anom</span> <span class="o">=</span> <span class="n">anoms_df</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">accum_anom</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accum. anomaly&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) accum. anomaly&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> and accumulated anomaly during period </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">)),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ma_anom</span> <span class="o">=</span> <span class="n">anoms_df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ma_anom</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period MA of anomaly&#39;</span> <span class="o">%</span><span class="n">w</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) </span><span class="si">%i</span><span class="s1">-period MA anom.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> and </span><span class="si">%i</span><span class="s1">-period MA of anomaly during period </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">)),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>


        <span class="c1"># Legends</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                            <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.185</span><span class="p">),</span>
                            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>

        <span class="c1"># Show seasons</span>
        <span class="k">if</span> <span class="n">show_seasons</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">season_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="s1">&#39;#32a852&#39;</span><span class="p">,</span> <span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="s1">&#39;#d6db46&#39;</span><span class="p">,</span> <span class="s2">&quot;#4696db&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#32a852&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#d6db46&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="c1">#plt.text(0.03, 0.925, &#39;Period with data: %i-%i&#39; %(df.index.year.min(),df.index.year.max()), fontsize=12, transform=plt.gcf().transFigure)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.915</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotdir</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">_and_</span><span class="si">%s</span><span class="s1">anom_climate</span><span class="si">%s%i%i</span><span class="s1">.png&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">secondplot_type</span><span class="p">,</span> <span class="n">climate_stat</span><span class="p">,</span> <span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>





<div class="viewcode-block" id="plot_data_and_yearly_cycle">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_data_and_yearly_cycle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_data_and_yearly_cycle</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">df_climate</span><span class="p">,</span><span class="n">year_to_plot</span><span class="p">,</span><span class="n">vars_list</span><span class="p">,</span><span class="n">units_list</span><span class="p">,</span><span class="n">colormap</span><span class="p">,</span><span class="n">database</span><span class="p">,</span> <span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">plotdir</span><span class="p">,</span> <span class="n">climate_stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">fillcolor_gradient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_seasons</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot climatological data of one variable against the climatological mean or median, and their yearly cycle.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    df_climate: DataFrame</span>
<span class="sd">        DataFrame containing the climatological data</span>
<span class="sd">    year_to_plot: int</span>
<span class="sd">        Year of the data to be plotted</span>
<span class="sd">    vars_list: str</span>
<span class="sd">        Variable(s) to be plotted</span>
<span class="sd">    units_list: str</span>
<span class="sd">        Units of the variable(s) to be plotted</span>
<span class="sd">    inidate: datetime.datetime</span>
<span class="sd">        First date to be plotted</span>
<span class="sd">    enddate: datetime.datetime</span>
<span class="sd">        Last date to be plotted</span>
<span class="sd">    colormap: matplotlib colormap</span>
<span class="sd">        Colormap to be used in plotting</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    plotdir: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    climate_stat: str</span>
<span class="sd">        Metric to compute the climatological normal values (mean or median)</span>
<span class="sd">    fillcolor_gradient: boolean</span>
<span class="sd">        Parameter that controls the way the colormap is employed. If true, the colormap is continue</span>
<span class="sd">    show_seasons: boolean</span>
<span class="sd">        If true, the background is plotted with different colors for each climatological season    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(vars_list) must be greater or equal than 1. Your vars_list has a length of: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">]</span>
    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-01-01&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-12-31&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">:</span>
        <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-01-01&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-12-31&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">))</span>

    <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">MonthLocator</span><span class="p">()</span> <span class="c1">#minticks=3, maxticks=12)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">)):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">units_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;cm&#39;</span><span class="p">]:</span>
            <span class="n">median</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">)</span>
            <span class="n">diff_var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>
            <span class="c1">#print(diff_var)</span>
            <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&gt;=</span> <span class="mi">0</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="o">-</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">([</span><span class="mi">1000</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>


            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

            <span class="c1"># Accumulated mean</span>
            <span class="n">accum_mean</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span>
            <span class="n">accum_mean</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_nocount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">accum_mean</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accum_mean</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">accum_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">accum_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">accum_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

            <span class="n">accum_mean</span><span class="p">[</span><span class="s1">&#39;cummean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accum_mean</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">/</span> <span class="n">accum_mean</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>

            <span class="n">accum_mean_climate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span>
            <span class="n">accum_mean_climate</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_nocount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">]</span>
            <span class="n">accum_mean_climate</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accum_mean_climate</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">accum_mean_climate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">accum_mean_climate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nc</span>
                    <span class="n">nc</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">accum_mean_climate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nc</span>

            <span class="n">accum_mean_climate</span><span class="p">[</span><span class="s1">&#39;cummean climate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accum_mean_climate</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">]</span><span class="o">/</span> <span class="n">accum_mean_climate</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>


            <span class="n">accum_mean_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">accum_mean</span><span class="p">[</span><span class="s1">&#39;cummean&#39;</span><span class="p">],</span> <span class="n">accum_mean_climate</span><span class="p">[</span><span class="s1">&#39;cummean climate&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">accum_mean_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; climate&#39;</span><span class="p">]</span>
            <span class="n">accum_mean_all</span><span class="p">[</span><span class="s1">&#39;anomaly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accum_mean_all</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">accum_mean_all</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; climate&#39;</span><span class="p">]</span>


            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">accum_mean_all</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accum. mean </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">accum_mean_all</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; climate&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accum. mean climate&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fillcolor_gradient</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">where</span><span class="o">=</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">where</span><span class="o">=</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">fill_between_colormap</span><span class="p">(</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">accum_mean_all</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
                <span class="c1"># Add color bar</span>
                <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">([</span><span class="mf">1.025</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
                <span class="n">cbar</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">),</span><span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span> <span class="c1">#, shrink=.98,ticks=levels, pad=0.02)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">units_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>


            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) accum. mean&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

            <span class="c1"># Indicate last accumulated anomaly:</span>
            <span class="c1"># these are matplotlib.patch.Patch properties</span>
            <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;Last accumulated anomaly: </span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anomaly&#39;</span><span class="p">])[</span><span class="s1">&#39;anomaly&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="s1">&#39;Daily </span><span class="si">%s</span><span class="s1"> and accumulated mean during period </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">)),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff_var1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">)]</span>
            <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var1</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var1</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">mask3</span> <span class="o">=</span> <span class="n">diff_var1</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#32a852&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#996100&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask3</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">mask3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

            <span class="c1"># Accumulated value</span>
            <span class="n">cum_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cum_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; climate&#39;</span><span class="p">]</span>
            <span class="n">cum_df</span><span class="p">[</span><span class="s1">&#39;anomaly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cum_df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">cum_df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; climate&#39;</span><span class="p">]</span>


            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accum. rainfall </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_df</span><span class="p">[</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; climate&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accum. rainfall climate&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fillcolor_gradient</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">cum_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">cum_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">where</span><span class="o">=</span><span class="n">cum_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">cum_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">cum_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">accum_mean_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">cum_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">where</span><span class="o">=</span><span class="n">cum_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="n">cum_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">=</span><span class="n">fill_between_colormap</span><span class="p">(</span><span class="n">cum_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">cum_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> climate&#39;</span> <span class="o">%</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cum_df</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
                <span class="c1"># axins = ax[1].inset_axes([0.8, 0.01, 0.17, 0.02])</span>
               <span class="c1"># cbar = matplotlib.colorbar.ColorbarBase(axins, cmap=cum_df, orientation=&#39;horizontal&#39;,location=&#39;lower right&#39;)</span>


            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) accum.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">units_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

            <span class="c1"># Indicate last accumulated anomaly:</span>
            <span class="c1"># these are matplotlib.patch.Patch properties</span>
            <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;Last accumulated anomaly: </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">cum_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anomaly&#39;</span><span class="p">])[</span><span class="s1">&#39;anomaly&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="s1">&#39;Timeseries of </span><span class="si">%s</span><span class="s1"> and accumulated mean during period </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%Y&#39;</span><span class="p">)),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>


        <span class="c1"># Legends        </span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                            <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.185</span><span class="p">),</span>
                            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>

        <span class="c1"># Show seasons</span>
        <span class="k">if</span> <span class="n">show_seasons</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">season_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="s1">&#39;#32a852&#39;</span><span class="p">,</span> <span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="s1">&#39;#d6db46&#39;</span><span class="p">,</span> <span class="s2">&quot;#4696db&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#32a852&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#d6db46&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="c1">#plt.text(0.03, 0.925, &#39;Period with data: %i-%i&#39; %(df.index.year.min(),df.index.year.max()), fontsize=12, transform=plt.gcf().transFigure)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotdir</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">_and_yearlycycleaccum_climate</span><span class="si">%s%i%i</span><span class="s1">.png&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">climate_stat</span><span class="p">,</span> <span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_timeseries">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_timeseries">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_timeseries</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_climate</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">plot_MA</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">climate_stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot climatological data of one variable against the climatological mean or median, and their cumulative or moving mean.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    var: str</span>
<span class="sd">        Variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    colors: list</span>
<span class="sd">        List of colors to plot (one for each variable in vars_list)</span>
<span class="sd">    plot_MA: boolean</span>
<span class="sd">        If True, plots the moving average of that variable with period=window</span>
<span class="sd">    climate_stat: str</span>
<span class="sd">        Metric to compute the climatological normal values (mean or median)</span>
<span class="sd">    window: int</span>
<span class="sd">        Length of the moving average period</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>

    <span class="k">if</span> <span class="n">plot_MA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">],</span><span class="s1">&#39;k-&#39;</span><span class="p">,</span><span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="s1">&#39;b--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Record min.: </span><span class="si">%.1f</span><span class="s1">ºC [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Record max.: </span><span class="si">%.1f</span><span class="s1">ºC [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">plot_MA</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-MA&#39;</span> <span class="o">%</span><span class="n">window</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">climate_stat</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate normal&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p090&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">],</span><span class="n">df_climate</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p010&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;10</span><span class="si">%-90%</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df_climate</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p095&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">],</span><span class="n">df_climate</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_p005&#39;</span> <span class="o">%</span><span class="n">var</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;5</span><span class="si">%-95%</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;+-1std&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">units</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_MA</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Timeseries of </span><span class="si">%s</span><span class="s1"> [</span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Timeseries of </span><span class="si">%s</span><span class="s1"> MA [</span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">),</span><span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">)])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.825</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="timeseries_extremevalues">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.timeseries_extremevalues">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">timeseries_extremevalues</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">time_scale</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot the timeseries of the: maximum, minimum, p010 and p090 values of several variables.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    var: str</span>
<span class="sd">        Variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    time_scale: str</span>
<span class="sd">        The time scale for which extract the extreme values. It can be: &#39;Year&#39;, &#39;Month&#39; or &#39;season&#39;.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>

    <span class="k">if</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;season&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;time_scale&quot; must be &quot;Year&quot; or &quot;Month&quot; or &quot;season&quot;&#39;</span><span class="p">)</span>

    <span class="c1"># Group to season</span>
    <span class="n">month_to_season_lu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;DJF&#39;</span><span class="p">,</span> <span class="s1">&#39;DJF&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DJF&#39;</span>
    <span class="p">])</span>
    <span class="n">grp_ary</span> <span class="o">=</span> <span class="n">month_to_season_lu</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp_ary</span>

    <span class="c1"># Step 1: Compute desired percentiles</span>
    <span class="k">if</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
        <span class="n">df_extremes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;min. value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                                    <span class="s1">&#39;p10 value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
                                                    <span class="s1">&#39;p90 value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">),</span>
                                                    <span class="s1">&#39;max. value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()})</span>
        <span class="c1">##  Broken y-axis figure</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Trend lines</span>
        <span class="n">slope_max</span><span class="p">,</span> <span class="n">intercept_max</span><span class="p">,</span> <span class="n">r_value_max</span><span class="p">,</span> <span class="n">pv_max</span><span class="p">,</span> <span class="n">se_max</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;max. value&#39;</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;max. value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual max.&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_max</span> <span class="o">+</span> <span class="n">slope_max</span><span class="o">*</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trend: </span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/decade&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_max</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
        <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;max. value&quot;, data=df_extremes, ax=ax1, marker=None, color=&#39;red&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

        <span class="n">slope_p90</span><span class="p">,</span> <span class="n">intercept_p90</span><span class="p">,</span> <span class="n">r_value_p90</span><span class="p">,</span> <span class="n">pv_p90</span><span class="p">,</span> <span class="n">se_p90</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;p90 value&#39;</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;p90 value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual p90&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_p90</span> <span class="o">+</span> <span class="n">slope_p90</span><span class="o">*</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trend: </span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/decade&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_p90</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
        <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;p90 value&quot;, data=df_extremes, ax=ax1, marker=None, color=&#39;salmon&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

        <span class="n">slope_p10</span><span class="p">,</span> <span class="n">intercept_p10</span><span class="p">,</span> <span class="n">r_value_p10</span><span class="p">,</span> <span class="n">pv_p10</span><span class="p">,</span> <span class="n">se_p10</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;p10 value&#39;</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;p10 value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;deepskyblue&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual p10&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_p10</span> <span class="o">+</span> <span class="n">slope_p10</span><span class="o">*</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;deepskyblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trend: </span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/decade&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_p10</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
        <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;p10 value&quot;, data=df_extremes, ax=ax2, marker=None, color=&#39;deepskyblue&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

        <span class="n">slope_min</span><span class="p">,</span> <span class="n">intercept_min</span><span class="p">,</span> <span class="n">r_value_min</span><span class="p">,</span> <span class="n">pv_min</span><span class="p">,</span> <span class="n">se_min</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;min. value&#39;</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;min. value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual min.&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_min</span> <span class="o">+</span> <span class="n">slope_min</span><span class="o">*</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trend: </span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/decade&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_min</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
        <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;min. value&quot;, data=df_extremes, ax=ax2, marker=None, color=&#39;blue&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

        <span class="c1"># zoom-in / limit the view to different portions of the data</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;p90 value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df_extremes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># outliers only</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df_extremes</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">),</span> <span class="n">df_extremes</span><span class="p">[</span><span class="s1">&#39;p10 value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># outliers only</span>

        <span class="c1"># hide the spines between ax and ax2</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">bottom</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_top</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>  <span class="c1"># don&#39;t put tick labels at the top</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Slanted lines</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mf">.5</span>  <span class="c1"># proportion of vertical to horizontal extent of the slanted line</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">)],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1">## legend</span>
        <span class="c1">#ax1.legend(bbox_to_anchor=(0.4, -0.22),ncol=2,fontsize=14).set_visible(True)</span>
        <span class="c1">#ax2.legend().set_visible(False)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">units</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Annual extreme values for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span>
        <span class="n">month_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
        <span class="n">df_extremes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;min. value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Year&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                                <span class="s1">&#39;p10 value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Year&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
                                                <span class="s1">&#39;p90 value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Year&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">),</span>
                                                <span class="s1">&#39;max. value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Year&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()})</span>

        <span class="n">df_extremes</span> <span class="o">=</span> <span class="n">df_extremes</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1">##  Broken y-axis figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> <span class="c1">#(8, 3, sharex=True, figsize=(15,10))</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_extremes</span><span class="p">[</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">Month</span> <span class="o">==</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">])</span>

            <span class="n">gss</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpecFromSubplotSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="o">=</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gss</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>

            <span class="c1"># Trend lines</span>
            <span class="n">slope_max</span><span class="p">,</span> <span class="n">intercept_max</span><span class="p">,</span> <span class="n">r_value_max</span><span class="p">,</span> <span class="n">pv_max</span><span class="p">,</span> <span class="n">se_max</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;max. value&#39;</span><span class="p">])</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;max. value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual max.&#39;</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_max</span> <span class="o">+</span> <span class="n">slope_max</span><span class="o">*</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/10y&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_max</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
            <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;max. value&quot;, data=df_extremes, ax=ax1, marker=None, color=&#39;red&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

            <span class="n">slope_p90</span><span class="p">,</span> <span class="n">intercept_p90</span><span class="p">,</span> <span class="n">r_value_p90</span><span class="p">,</span> <span class="n">pv_p90</span><span class="p">,</span> <span class="n">se_p90</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p90 value&#39;</span><span class="p">])</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p90 value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual p90&#39;</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_p90</span> <span class="o">+</span> <span class="n">slope_p90</span><span class="o">*</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/10y&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_p90</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
            <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;p90 value&quot;, data=df_extremes, ax=ax1, marker=None, color=&#39;salmon&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

            <span class="n">slope_p10</span><span class="p">,</span> <span class="n">intercept_p10</span><span class="p">,</span> <span class="n">r_value_p10</span><span class="p">,</span> <span class="n">pv_p10</span><span class="p">,</span> <span class="n">se_p10</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p10 value&#39;</span><span class="p">])</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p10 value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;deepskyblue&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual p10&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_p10</span> <span class="o">+</span> <span class="n">slope_p10</span><span class="o">*</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;deepskyblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/10y&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_p10</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
            <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;p10 value&quot;, data=df_extremes, ax=ax2, marker=None, color=&#39;deepskyblue&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

            <span class="n">slope_min</span><span class="p">,</span> <span class="n">intercept_min</span><span class="p">,</span> <span class="n">r_value_min</span><span class="p">,</span> <span class="n">pv_min</span><span class="p">,</span> <span class="n">se_min</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;min. value&#39;</span><span class="p">])</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;min. value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual min.&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_min</span> <span class="o">+</span> <span class="n">slope_min</span><span class="o">*</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/10y&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_min</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>

            <span class="c1"># zoom-in / limit the view to different portions of the data</span>
            <span class="c1"># Set y-axes limits</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p90 value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># outliers only</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">),</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p10 value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># outliers only</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">bottom</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_top</span><span class="p">()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># don&#39;t put tick labels at the top</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># don&#39;t put tick labels at the top</span>

            <span class="k">if</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ax0</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">),</span><span class="n">ax0</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Slanted lines</span>
                <span class="n">d</span> <span class="o">=</span> <span class="mf">.5</span>  <span class="c1"># proportion of vertical to horizontal extent of the slanted line</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">)],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax0</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># legend</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                <span class="c1">#ax0.legend(bbox_to_anchor=(0.3, -0.52),ncol=2,fontsize=13).set_visible(True)</span>
                <span class="c1"># Put a legend below current axis</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">),</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">ax0</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Axis title</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">month_names</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Text</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">units</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Monthly extreme values for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;season&#39;</span><span class="p">:</span>
        <span class="n">df_extremes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;min. value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;season&#39;</span><span class="p">,</span><span class="s1">&#39;Year&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                                <span class="s1">&#39;p10 value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;season&#39;</span><span class="p">,</span><span class="s1">&#39;Year&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
                                                <span class="s1">&#39;p90 value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;season&#39;</span><span class="p">,</span><span class="s1">&#39;Year&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">),</span>
                                                <span class="s1">&#39;max. value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;season&#39;</span><span class="p">,</span><span class="s1">&#39;Year&#39;</span><span class="p">])[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()})</span>

        <span class="n">df_extremes</span> <span class="o">=</span> <span class="n">df_extremes</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1">##  Broken y-axis figure</span>
        <span class="c1">#fig, axs = plt.subplots(8,3, sharex=True, figsize=(15,10))</span>
        <span class="n">season_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">]</span>
        <span class="n">season_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;December-January-February&#39;</span><span class="p">,</span> <span class="s1">&#39;March-April-May&#39;</span><span class="p">,</span> <span class="s1">&#39;June-July-August&#39;</span><span class="p">,</span> <span class="s1">&#39;September-October-November&#39;</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> <span class="c1">#(8, 3, sharex=True, figsize=(15,10))</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        <span class="c1"># ax = axs.flatten()</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_extremes</span><span class="p">[</span><span class="n">df_extremes</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="n">season_names</span><span class="p">[</span><span class="n">n</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">])</span>

            <span class="n">gss</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpecFromSubplotSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="o">=</span><span class="n">gs</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gss</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>

            <span class="c1"># Trend lines</span>
            <span class="n">slope_max</span><span class="p">,</span> <span class="n">intercept_max</span><span class="p">,</span> <span class="n">r_value_max</span><span class="p">,</span> <span class="n">pv_max</span><span class="p">,</span> <span class="n">se_max</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;max. value&#39;</span><span class="p">])</span>
            <span class="n">a</span><span class="p">,</span><span class="o">=</span><span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;max. value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual max.&#39;</span><span class="p">)</span>
            <span class="n">a_t</span><span class="p">,</span><span class="o">=</span><span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_max</span> <span class="o">+</span> <span class="n">slope_max</span><span class="o">*</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/10y&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_max</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
            <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;max. value&quot;, data=df_extremes, ax=ax1, marker=None, color=&#39;red&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

            <span class="n">slope_p90</span><span class="p">,</span> <span class="n">intercept_p90</span><span class="p">,</span> <span class="n">r_value_p90</span><span class="p">,</span> <span class="n">pv_p90</span><span class="p">,</span> <span class="n">se_p90</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p90 value&#39;</span><span class="p">])</span>
            <span class="n">b</span><span class="p">,</span><span class="o">=</span><span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p90 value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual p90&#39;</span><span class="p">)</span>
            <span class="n">b_t</span><span class="p">,</span><span class="o">=</span><span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_p90</span> <span class="o">+</span> <span class="n">slope_p90</span><span class="o">*</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/10y&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_p90</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
            <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;p90 value&quot;, data=df_extremes, ax=ax1, marker=None, color=&#39;salmon&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

            <span class="n">slope_p10</span><span class="p">,</span> <span class="n">intercept_p10</span><span class="p">,</span> <span class="n">r_value_p10</span><span class="p">,</span> <span class="n">pv_p10</span><span class="p">,</span> <span class="n">se_p10</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p10 value&#39;</span><span class="p">])</span>
            <span class="n">c</span><span class="p">,</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p10 value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;deepskyblue&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual p10&#39;</span><span class="p">)</span>
            <span class="n">c_t</span><span class="p">,</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_p10</span> <span class="o">+</span> <span class="n">slope_p10</span><span class="o">*</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;deepskyblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/10y&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_p10</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>
            <span class="c1">#sns.regplot(x=df_extremes.index, y=&quot;p10 value&quot;, data=df_extremes, ax=ax2, marker=None, color=&#39;deepskyblue&#39;,robust=True, scatter_kws={&#39;s&#39;: 80, &#39;edgecolor&#39;: &#39;black&#39;})</span>

            <span class="n">slope_min</span><span class="p">,</span> <span class="n">intercept_min</span><span class="p">,</span> <span class="n">r_value_min</span><span class="p">,</span> <span class="n">pv_min</span><span class="p">,</span> <span class="n">se_min</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;min. value&#39;</span><span class="p">])</span>
            <span class="n">d</span><span class="p">,</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;min. value&#39;</span><span class="p">],</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Annual min.&#39;</span><span class="p">)</span>
            <span class="n">d_t</span><span class="p">,</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">intercept_min</span> <span class="o">+</span> <span class="n">slope_min</span><span class="o">*</span><span class="n">df_plot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">/10y&#39;</span> <span class="o">%</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">slope_min</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>


            <span class="c1"># zoom-in / limit the view to different portions of the data</span>
            <span class="c1"># Set y-axes limits</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p90 value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># outliers only</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">),</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;p10 value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># outliers only</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">bottom</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_top</span><span class="p">()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># don&#39;t put tick labels at the top</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># don&#39;t put tick labels at the top</span>

            <span class="k">if</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ax0</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">),</span><span class="n">ax0</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Slanted lines</span>
                <span class="n">d</span> <span class="o">=</span> <span class="mf">.5</span>  <span class="c1"># proportion of vertical to horizontal extent of the slanted line</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">)],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax0</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Create another legend for the records.</span>
            <span class="c1">#second_legend = ax1.legend(handles=[a_t, b_t], bbox_to_anchor=(0.1, 1.05), ncol=2)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">a_t</span><span class="p">,</span> <span class="n">b_t</span><span class="p">,</span> <span class="n">c_t</span><span class="p">,</span> <span class="n">d_t</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="c1">#, bbox_to_anchor=(0.99, 1.06), ncol=2, fontsize=13).set_visible(True)</span>
            <span class="c1">#ax1.legend(handles=[c_t, d_t], loc=&#39;upper right&#39;, ncol=2)</span>
            <span class="c1"># Add the legend manually to the Axes.</span>
            <span class="c1">#fig.add_artist(second_legend)</span>
            <span class="c1">#fig.add_artist(third_legend)</span>


            <span class="n">ax0</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Axis title</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">season_labels</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Seasonal extreme values for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_yearly_cycles">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_yearly_cycles">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_yearly_cycles</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">yearly_cycle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">):</span> <span class="c1">#, units, climate_normal_period, database, station_name, plotdir, criterion=&#39;latest&#39;):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot the yearly cycles of one variable for every year included in data</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    variable: str</span>
<span class="sd">        Variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    colors: list</span>
<span class="sd">        List of colors to be used in plotting</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    yearly_cycle: boolean</span>
<span class="sd">        If false, it plots the yearly data as it happened, insted of the yearly cycle</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>


    <span class="k">if</span> <span class="n">criterion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">,</span> <span class="s1">&#39;lowest&#39;</span><span class="p">,</span> <span class="s1">&#39;latest&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;criterion&quot; must be &quot;highest&quot; or &quot;lowest&quot; or &quot;latest&quot;&#39;</span><span class="p">)</span>

    <span class="c1"># Remove years with not enough data</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">y</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">365</span><span class="o">*</span><span class="mf">0.15</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">!=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">y</span><span class="p">]</span>


    <span class="k">if</span> <span class="n">yearly_cycle</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">criterion</span> <span class="o">==</span> <span class="s1">&#39;highest&#39;</span><span class="p">:</span>
            <span class="n">highlighted_years</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">year_to_plot</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">elif</span> <span class="n">criterion</span> <span class="o">==</span> <span class="s1">&#39;lowest&#39;</span><span class="p">:</span>
            <span class="n">highlighted_years</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">year_to_plot</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">elif</span> <span class="n">criterion</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span>
            <span class="n">highlighted_years</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">year_to_plot</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">criterion</span> <span class="o">==</span> <span class="s1">&#39;highest&#39;</span><span class="p">:</span>
            <span class="n">highlighted_years</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">31</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
        <span class="k">elif</span> <span class="n">criterion</span> <span class="o">==</span> <span class="s1">&#39;lowest&#39;</span><span class="p">:</span>
            <span class="n">highlighted_years</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">31</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
        <span class="k">elif</span> <span class="n">criterion</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span>
            <span class="n">highlighted_years</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">31</span><span class="p">)][</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>



    <span class="c1"># Comparo con 3 años más calidos</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="c1">#ax.set_facecolor(&#39;#fafcd4&#39;)</span>

    <span class="c1"># Ploteo añor normales de gris (elimino días bisiestos)</span>
    <span class="k">for</span> <span class="n">ye</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">highlighted_years</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span> <span class="c1"># and not in [year_to_plot]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">ye</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">ye</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#ax.plot(np.arange(0,len(df1_complete_join.loc[df1_complete_join.index.year == ye].index),1), df1_complete_join.loc[df1_complete_join.index.year == ye, sorted(list(set(df1_complete_join.columns) &amp; set(variables)), key=lambda x: variables.index(x))[i]],color=&#39;grey&#39;, alpha=0.2, lw=0.9, zorder=0)</span>
    <span class="c1"># Ploteo años destacados con colores</span>
    <span class="k">for</span> <span class="n">ye</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">highlighted_years</span><span class="p">)):</span> <span class="c1"># and not in [year_to_plot]:</span>
        <span class="c1">#ax.plot(df1_complete_join.loc[df1_complete_join.index.year == annual_vals[sorted(list(set(df1_complete_join.columns) &amp; set(variables)), key=lambda x: variables.index(x))[i]].sort_values().index[-5:][ye]].index, df1_complete_join.loc[df1_complete_join.index.year == annual_vals[sorted(list(set(df1_complete_join.columns) &amp; set(variables)), key=lambda x: variables.index(x))[i]].sort_values().index[-5:][ye], sorted(list(set(df1_complete_join.columns) &amp; set(variables)), key=lambda x: variables.index(x))[i]],color=colores[ye])</span>
<span class="c1">#                ax.plot(np.arange(0,len(df1_complete_join.loc[df1_complete_join.index.year == annual_vals[sorted(list(set(df1_complete_join.columns) &amp; set(variables)), key=lambda x: variables.index(x))[i]].sort_values().index[-3:][ye]].index),1), df1_complete_join.loc[df1_complete_join.index.year == annual_vals[sorted(list(set(df1_complete_join.columns) &amp; set(variables)), key=lambda x: variables.index(x))[i]].sort_values().index[-3:][ye], sorted(list(set(df1_complete_join.columns) &amp; set(variables)), key=lambda x: variables.index(x))[i]],color=colores[ye], label=df1_complete_join[df1_complete_join.index.year.isin(annual_vals[sorted(list(set(df1_complete_join.columns) &amp; set(variables)), key=lambda x: variables.index(x))[i]].sort_values().index[-3:])].index.year.unique()[ye], lw=1.1, zorder=1)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">highlighted_years</span><span class="p">[</span><span class="n">ye</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">))]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">highlighted_years</span><span class="p">[</span><span class="n">ye</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)),</span> <span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">ye</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">highlighted_years</span><span class="p">[</span><span class="n">ye</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">year_to_plot</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)),</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)),</span> <span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">year_to_plot</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)),</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)),</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_median&#39;</span> <span class="o">%</span><span class="n">variable</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median [</span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)),</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">))]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maximum [</span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)),</span> <span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">year_to_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">))]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">])[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Minimum [</span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;year_to_plot has too many missing data to be plotted&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">criterion</span> <span class="o">==</span> <span class="s1">&#39;highest&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ºC&#39;</span><span class="p">,</span> <span class="s1">&#39;ºF&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;hottest years&#39;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;wettest years&#39;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;m/s&#39;</span><span class="p">,</span> <span class="s1">&#39;km/h&#39;</span><span class="p">,</span> <span class="s1">&#39;kts&#39;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;windiest years&#39;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">criterion</span> <span class="o">==</span> <span class="s1">&#39;lowest&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ºC&#39;</span><span class="p">,</span> <span class="s1">&#39;ºF&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;coldest years&#39;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;dryiest years&#39;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;m/s&#39;</span><span class="p">,</span> <span class="s1">&#39;km/h&#39;</span><span class="p">,</span> <span class="s1">&#39;kts&#39;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;calmest years&#39;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">criterion</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;latest years&#39;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.185</span><span class="p">),</span>
                        <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">211</span><span class="p">,</span><span class="mi">242</span><span class="p">,</span><span class="mi">272</span><span class="p">,</span><span class="mi">303</span><span class="p">,</span><span class="mi">333</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span><span class="s1">&#39;Feb&#39;</span><span class="p">,</span><span class="s1">&#39;Mar&#39;</span><span class="p">,</span><span class="s1">&#39;Apr&#39;</span><span class="p">,</span><span class="s1">&#39;May&#39;</span><span class="p">,</span><span class="s1">&#39;Jun&#39;</span><span class="p">,</span><span class="s1">&#39;Jul&#39;</span><span class="p">,</span><span class="s1">&#39;Aug&#39;</span><span class="p">,</span><span class="s1">&#39;Sep&#39;</span><span class="p">,</span><span class="s1">&#39;Oct&#39;</span><span class="p">,</span><span class="s1">&#39;Nov&#39;</span><span class="p">,</span><span class="s1">&#39;Dec&#39;</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Yearly cycle of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">variable</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.97</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_yearly_cycle">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.get_yearly_cycle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_yearly_cycle</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_climate</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to extract the yearly cycles of selected variables</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    df_climate: DataFrame</span>
<span class="sd">        DataFrame containing the climatological data</span>
<span class="sd">    vars_list: str</span>
<span class="sd">        Variable(s) to be extracted</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">accum_mean_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_list</span><span class="p">:</span>
        <span class="n">accum_mean_tmp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="c1"># Accumulated mean</span>
            <span class="n">accum_mean</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">y</span><span class="p">,</span> <span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span>
            <span class="n">accum_mean</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_nocount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">y</span><span class="p">,</span> <span class="n">var</span><span class="p">]</span>
            <span class="n">accum_mean</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accum_mean</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">accum_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">accum_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">accum_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

            <span class="n">accum_mean</span><span class="p">[</span><span class="s1">&#39;cummean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accum_mean</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">/</span> <span class="n">accum_mean</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>

            <span class="n">accum_mean_climate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">y</span><span class="p">,</span> <span class="n">var</span><span class="o">+</span><span class="s1">&#39;_median&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span>
            <span class="n">accum_mean_climate</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_nocount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">y</span><span class="p">,</span> <span class="n">var</span><span class="o">+</span><span class="s1">&#39;_median&#39;</span><span class="p">]</span>
            <span class="n">accum_mean_climate</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accum_mean_climate</span><span class="p">)):</span>
                <span class="n">accum_mean_climate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">accum_mean_climate</span><span class="p">[</span><span class="s1">&#39;cummean climate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accum_mean_climate</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_median&#39;</span><span class="p">]</span><span class="o">/</span> <span class="n">accum_mean_climate</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>



            <span class="n">accum_mean_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">accum_mean</span><span class="p">[</span><span class="s1">&#39;cummean&#39;</span><span class="p">],</span> <span class="n">accum_mean_climate</span><span class="p">[</span><span class="s1">&#39;cummean climate&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">accum_mean_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="o">+</span><span class="s1">&#39;_median&#39;</span><span class="p">]</span>

            <span class="n">accum_mean_tmp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">accum_mean_tmp_df</span><span class="p">,</span> <span class="n">accum_mean_all</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">accum_mean_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">accum_mean_df</span><span class="p">,</span> <span class="n">accum_mean_tmp_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="n">accum_mean_df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accum_mean_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
    <span class="n">accum_mean_df</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accum_mean_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
    <span class="n">accum_mean_df</span><span class="p">[</span><span class="s1">&#39;Day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accum_mean_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span>

    <span class="k">return</span> <span class="n">accum_mean_df</span></div>



<div class="viewcode-block" id="annual_meteogram">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.annual_meteogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">annual_meteogram</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_climate</span><span class="p">,</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span><span class="n">plot_anoms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_seasons</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot and compare the annual meteogram of a certain year (year_to_plot) with the climatological normal</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    df_climate: DataFrame</span>
<span class="sd">        DataFrame containing the climatological normal data</span>
<span class="sd">    year_to_plot: int</span>
<span class="sd">        Year to be plotted</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    plot_anoms: boolean</span>
<span class="sd">        If true, temperature and wind values will be plotted as departures from the climatological selected statistic    </span>
<span class="sd">    show_seasons: boolean</span>
<span class="sd">        If true, the background is plotted with different colors for each climatological season    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;Temp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The temperature data should be included in df with column name &quot;Temp&quot;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;Rainfall&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The rainfall data should be included in df with column name &quot;Rainfall&quot;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;WindSpeed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The wind speed data should be included in df with column name &quot;WindSpeed&quot;&#39;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">]</span>
    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">]</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Accum. Rainfall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Rainfall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">df_climate</span><span class="p">[</span><span class="s1">&#39;Accum. Rainfall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_climate</span><span class="p">[</span><span class="s1">&#39;Rainfall_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-01-01&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-12-31&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">:</span>
        <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-01-01&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-12-31&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">))</span>


    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">fmt_minor</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">DayLocator</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">AutoDateLocator</span><span class="p">(</span><span class="n">minticks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxticks</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">,</span> <span class="n">zero_formats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">offset_formats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">])</span>


    <span class="n">Tmedian</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Temp&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate normal&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_anoms</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;Temp&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diff_var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Temp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;Temp&#39;</span><span class="p">]</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Temp&#39;</span><span class="p">][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;#34b1eb&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Temp&#39;</span><span class="p">][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#eb4034&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>


    <span class="n">accumrainmedian</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Accum. Rainfall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Accum. Rainfall&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Accum. Rainfall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;Accum. Rainfall&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Rainfall_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;Rainfall_mean&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate normal&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;Rainfall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;Rainfall&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="n">windmedian</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;WindSpeed_median&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;WindSpeed_median&#39;</span> <span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Climate normal&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_anoms</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;WindSpeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;WindSpeed&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year_to_plot</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diff_var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;WindSpeed&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span><span class="s1">&#39;WindSpeed_median&#39;</span><span class="p">]</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">diff_var</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;WindSpeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;WindSpeed_median&#39;</span><span class="p">][</span><span class="n">mask1</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;#34b1eb&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;WindSpeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_climate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="s1">&#39;WindSpeed_median&#39;</span><span class="p">][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">height</span> <span class="o">=</span> <span class="n">diff_var</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#eb4034&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>




    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Show seasons</span>
        <span class="k">if</span> <span class="n">show_seasons</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">season_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="s1">&#39;#32a852&#39;</span><span class="p">,</span> <span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="s1">&#39;#d6db46&#39;</span><span class="p">,</span> <span class="s2">&quot;#4696db&quot;</span><span class="p">]</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#32a852&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#da5757&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#d6db46&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">),</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_to_plot</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4696db&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>


    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mf">14.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daily temperature&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daily and accumulated rainfall&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daily mean wind speed&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.185</span><span class="p">),</span>
                        <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.031</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.031</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span> <span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.79</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.79</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="c1">#fig.autofmt_xdate()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_accumulated_anomalies">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_accumulated_anomalies">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_accumulated_anomalies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">year_to_plot</span><span class="p">,</span> <span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot the evolution along years of the anomalies with respect with the climatological normal</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    var: str</span>
<span class="sd">        Name of the variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    year_to_plot: int</span>
<span class="sd">        Year to be highlighted</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    window: int</span>
<span class="sd">        Length of the window for plotting moving average of the anomalies</span>
<span class="sd">    gfreq: int</span>
<span class="sd">        The frequency of each group to be analysed</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>

    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="n">var</span><span class="p">]</span>

    <span class="c1"># 1. Compute anomalies</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">var</span><span class="p">]]</span>
    <span class="c1">#df_anoms = df_anoms.groupby([df_anoms.index.month,df_anoms.index.day]).mean(numeric_only=True)</span>
    <span class="c1">#df_anoms = df_anoms[~((df_anoms.index.get_level_values(1) == 29) &amp; (df_anoms.index.get_level_values(0)  == 2))][var]</span>

    <span class="n">df_climate_anoms</span> <span class="o">=</span> <span class="n">df_climate</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))]</span>
    <span class="n">df_climate_anoms</span> <span class="o">=</span> <span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_climate_anoms</span> <span class="o">=</span> <span class="n">df_climate_anoms</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="o">==</span> <span class="mi">2</span><span class="p">))]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_climate&#39;</span><span class="p">]</span>

    <span class="n">df_anoms</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_climate_anoms</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">])</span>
    <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_anom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_climate&#39;</span><span class="p">]</span>
    <span class="n">df_anoms</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>


    <span class="c1"># 2. Grouping</span>
    <span class="n">df_anoms</span> <span class="o">=</span> <span class="n">df_anoms</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 2.1 After grouping, group by year and compute cumulative anomalies</span>
    <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">final_anom</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Save final anomalies for plotting reasons</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">df_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">df_year</span> <span class="o">=</span> <span class="n">df_anoms</span><span class="p">[</span><span class="n">df_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_year</span><span class="p">[</span><span class="s1">&#39;anom_cumsum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_year</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_anom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">df_year</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_cumanom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_year</span><span class="p">[</span><span class="s1">&#39;anom_cumsum&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">df_year</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">df_dict</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_year</span>
        <span class="n">final_anom</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_year</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df_year</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_cumanom&#39;</span><span class="p">]</span>

    <span class="c1"># Get lowest and highest final anomalies</span>
    <span class="n">lowest_anom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">final_anom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">final_anom</span><span class="o">.</span><span class="n">get</span><span class="p">)</span> <span class="c1"># Get year with lowest anomaly</span>
    <span class="n">highest_anom</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">final_anom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">final_anom</span><span class="o">.</span><span class="n">get</span><span class="p">)</span> <span class="c1"># Get year with highest anomaly</span>

    <span class="c1"># Barras de anomalías mensuales</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

    <span class="c1"># 2.1 Plot values one year at a time</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">df_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">df_year</span> <span class="o">=</span> <span class="n">df_dict</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
<span class="c1">#        df_year[&#39;anom_cumsum&#39;] = df_year[var+&#39;_anom&#39;].cumsum()</span>
<span class="c1">#        df_year[var+&#39;_cumanom&#39;] = df_year[&#39;anom_cumsum&#39;] / (df_year.index + 1)</span>

        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="n">lowest_anom</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_year</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_year</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_cumanom&#39;</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lowest anom.: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">lowest_anom</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="n">highest_anom</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_year</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_year</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_cumanom&#39;</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Highest anom.: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">highest_anom</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="n">year_to_plot</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_year</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_year</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_cumanom&#39;</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">year_to_plot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_year</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_year</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_cumanom&#39;</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> anomaly [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1">#ax.set_title(&#39;%s cumulative anomaly&#39; %var, fontsize=18, wrap=True)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">df_year</span><span class="o">.</span><span class="n">index</span><span class="p">)])</span>
    <span class="k">if</span> <span class="s1">&#39;W&#39;</span> <span class="ow">in</span> <span class="n">freq</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">52</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">freq</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))])</span>
    <span class="k">if</span> <span class="s1">&#39;D&#39;</span> <span class="ow">in</span> <span class="n">freq</span><span class="p">:</span>
        <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">AutoDateLocator</span><span class="p">(</span><span class="n">maxticks</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> <span class="c1">#minticks=3, maxticks=12)</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;1M&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span><span class="s1">&#39; Dec&#39;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="s1">&#39;W&#39;</span> <span class="ow">in</span> <span class="n">freq</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">freq</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1">#ax.xaxis.set_major_locator(mdates.YearLocator(2))</span>
    <span class="c1"># Get only the year to show in the x-axis:</span>
    <span class="c1">#ax.xaxis.set_major_formatter(mdates.DateFormatter(&#39;%Y&#39;))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.77</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.77</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> anomaly [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_anomalies">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.plot_anomalies">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_anomalies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">climate_normal_period</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot the evolution along years of the anomalies with respect with the climatological normal</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    var: str</span>
<span class="sd">        Name of the variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    climate_normal_period: list</span>
<span class="sd">        First and last year of the reference period to be used as climatological normal</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    window: int</span>
<span class="sd">        Length of the window for plotting moving average of the anomalies</span>
<span class="sd">    gfreq: int</span>
<span class="sd">        The frequency of each group to be analysed</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>

    <span class="n">df_climate</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="n">var</span><span class="p">]</span>

    <span class="c1"># 1. Compute anomalies</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">var</span><span class="p">]]</span>
    <span class="c1">#df_anoms = df_anoms.groupby([df_anoms.index.month,df_anoms.index.day]).mean(numeric_only=True)</span>
    <span class="c1">#df_anoms = df_anoms[~((df_anoms.index.get_level_values(1) == 29) &amp; (df_anoms.index.get_level_values(0)  == 2))][var]</span>

    <span class="n">df_climate_anoms</span> <span class="o">=</span> <span class="n">df_climate</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))]</span>
    <span class="n">df_climate_anoms</span> <span class="o">=</span> <span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_climate_anoms</span> <span class="o">=</span> <span class="n">df_climate_anoms</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="o">==</span> <span class="mi">2</span><span class="p">))]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_climate_anoms</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span><span class="s1">&#39;Day&#39;</span><span class="p">,</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_climate&#39;</span><span class="p">]</span>

    <span class="n">df_anoms</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_climate_anoms</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">])</span>
    <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_anom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_climate&#39;</span><span class="p">]</span>
    <span class="n">df_anoms</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>


    <span class="c1"># 2. Grouping</span>
    <span class="n">df_anoms</span> <span class="o">=</span> <span class="n">df_anoms</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 3. Plotting</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

    <span class="n">mask1</span> <span class="o">=</span> <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_anom&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_anom&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask1</span><span class="p">[</span><span class="n">mask1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_anoms</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask1</span><span class="p">],</span> <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_anom&#39;</span><span class="p">][</span><span class="n">mask1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask2</span><span class="p">[</span><span class="n">mask2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_anoms</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask2</span><span class="p">],</span> <span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_anom&#39;</span><span class="p">][</span><span class="n">mask2</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> anomaly [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="c1">#    ax.set_xlim([0,max(df_year.index)])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_anoms</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;_anom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">-period MA&#39;</span> <span class="o">%</span><span class="n">window</span><span class="p">)</span>

    <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">AutoDateLocator</span><span class="p">(</span><span class="n">maxticks</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> <span class="c1">#minticks=3, maxticks=12)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1">#ax.xaxis.set_major_locator(mdates.YearLocator(2))</span>
    <span class="c1"># Get only the year to show in the x-axis:</span>
    <span class="c1">#ax.xaxis.set_major_formatter(mdates.DateFormatter(&#39;%Y&#39;))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">climate_normal_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.77</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.77</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> anomaly [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>


<div class="viewcode-block" id="compare_with_globaldataset">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.compare_with_globaldataset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_with_globaldataset</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">global_dataset</span><span class="o">=</span><span class="s1">&#39;HadCRUT&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to compare the annual trend of your timeseries with that of one global dataset</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    var: str</span>
<span class="sd">        Name of the variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    window: int</span>
<span class="sd">        Length of the window for moving average computation. If None, no moving average is computed and the original data anomalies are plotted.</span>
<span class="sd">    global_dataset: str</span>
<span class="sd">        The name of the dataset to compare with. At the moment, only &quot;HadCRUT&quot; is accepted.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="c1"># Current directory</span>

    <span class="n">normal_values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">1961</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">1990</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">normal_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Your data has not data within the period 1961-1990. Therefore, there cannot be perform a comparison with the global dataset. Exiting...&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">normal_values</span> <span class="o">=</span> <span class="n">normal_values</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">normal_values</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">normal_values</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">station_name</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> anomaly [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">global_dataset</span> <span class="o">==</span> <span class="s1">&#39;HadCRUT&#39;</span><span class="p">:</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39;\data\HadCRUT.5.1.0.0\HadCRUT.5.1.0.0.analysis.summary_series.global.annual.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">window</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> anomaly [</span><span class="si">%s</span><span class="s1">] </span><span class="si">%i</span><span class="s1">-year moving average&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>


    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">df1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">global_dataset</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">df1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">df1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> 95</span><span class="si">%%</span><span class="s1"> confidence interval&#39;</span> <span class="o">%</span><span class="n">global_dataset</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Anomaly to 1961-1900 [ºC]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Climate normal period: 1961-1990&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.77</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.77</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>


<div class="viewcode-block" id="categories_evolution">
<a class="viewcode-back" href="../../pyclim.html#pyclim.pyclim.categories_evolution">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">categories_evolution</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">categories_breaks</span><span class="p">,</span> <span class="n">categories_labels</span><span class="p">,</span> <span class="n">categories_colors</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">time_scale</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">grouping_stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function allows to plot the evolution of a certain variable by grouping it into categories</span>

<span class="sd">    Arguments</span>
<span class="sd">    ----------</span>
<span class="sd">    df: DataFrame</span>
<span class="sd">        DataFrame containing the data</span>
<span class="sd">    var: str</span>
<span class="sd">        Name of the variable to be plotted</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the variable to be plotted</span>
<span class="sd">    categories_breaks: list</span>
<span class="sd">        List containing the breaks of each category</span>
<span class="sd">    categories_labels: list</span>
<span class="sd">        List containing the labels of each category</span>
<span class="sd">    categories_colors: list</span>
<span class="sd">        List containing the colours of each category</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    database: str</span>
<span class="sd">        Name of the database from which the plotted data comes</span>
<span class="sd">    station_name: str</span>
<span class="sd">        Name of the location of the data</span>
<span class="sd">    filename: str</span>
<span class="sd">        Absolute path where the plot is going to be saved</span>
<span class="sd">    time_scale: str</span>
<span class="sd">        Time scale to which aggregate the number of exceedances</span>
<span class="sd">    grouping_stat: str</span>
<span class="sd">        The statistic for data grouping</span>

<span class="sd">   &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">yearmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="c1">#df.index.year.min()</span>
    <span class="n">yearmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Remember to include the lowest and highest limits in &quot;categories_breaks&quot;!!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories_labels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories_breaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Check your categories lists. The length of the labels list should be one less than the length of the categories values&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Your list of labels is empty. Setting labels using categories values...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">categories_breaks</span><span class="p">)):</span>
            <span class="n">categories_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">categories_breaks</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">categories_breaks</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories_colors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories_labels</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The number of colors is lower than the number of labels. Please, add more colors.&#39;</span><span class="p">)</span>


    <span class="c1">#### Step 1: Create categories of the desired variable</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">categories_breaks</span>
    <span class="n">labels</span><span class="o">=</span> <span class="n">categories_labels</span>
    <span class="n">binned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
        <span class="n">binned_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">binned</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;AS&#39;</span><span class="p">))]</span> <span class="c1">#binned.groupby(pd.Grouper(freq=&#39;AS&#39;)).apply(grouping_stat, numeric_only=True)</span>
        <span class="n">binned_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">categories_labels</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binned_list</span><span class="p">)):</span>
            <span class="c1">#binned_list[i][&#39;freq&#39;] = 0.0</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">binned_list_freq</span><span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">binned_list_freq</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

            <span class="n">binned_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">binned_df</span><span class="p">,</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">binned_df</span> <span class="o">=</span> <span class="n">binned_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#for boolean, weight_count in binned_df.items():</span>
        <span class="c1">#    p = ax.bar(species, weight_count, width, label=boolean, bottom=bottom)</span>
        <span class="c1">#    bottom += weight_count</span>
        <span class="n">binned_df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">categories_colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.185</span><span class="p">),</span>
                        <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.031</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="c1">#plt.suptitle(&#39;%s evolution and %i-period mean&#39; %(var, averaging_period), fontsize=22, y=0.97)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">] grouped by categories&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.97</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.075</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
        <span class="c1">#fig.autofmt_xdate()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency [%]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">categories_labels</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.1</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>

        <span class="c1"># Plot always 10 labels at most</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">binned_df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">xticks_spacing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[::</span><span class="n">xticks_spacing</span><span class="p">])</span> <span class="c1">#.values)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>


        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;season&#39;</span><span class="p">:</span>

        <span class="c1"># Group to season</span>
        <span class="n">month_to_season_lu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;DJF&#39;</span><span class="p">,</span> <span class="s1">&#39;DJF&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span> <span class="s1">&#39;MAM&#39;</span><span class="p">,</span>
            <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span> <span class="s1">&#39;JJA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span> <span class="s1">&#39;SON&#39;</span><span class="p">,</span>
            <span class="s1">&#39;DJF&#39;</span>
        <span class="p">])</span>
        <span class="n">grp_ary</span> <span class="o">=</span> <span class="n">month_to_season_lu</span><span class="p">[</span><span class="n">binned</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>
        <span class="n">binned</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp_ary</span>
        <span class="n">binned</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
        <span class="n">df_winter</span> <span class="o">=</span> <span class="n">binned</span><span class="p">[</span><span class="n">binned</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="s1">&#39;DJF&#39;</span><span class="p">]</span><span class="c1">#.groupby([&#39;Year&#39;]).apply(grouping_stat, numeric_only=True)</span>
        <span class="n">df_spring</span> <span class="o">=</span> <span class="n">binned</span><span class="p">[</span><span class="n">binned</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="s1">&#39;MAM&#39;</span><span class="p">]</span><span class="c1">#.groupby([&#39;Year&#39;]).apply(grouping_stat, numeric_only=True)</span>
        <span class="n">df_summer</span> <span class="o">=</span> <span class="n">binned</span><span class="p">[</span><span class="n">binned</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="s1">&#39;JJA&#39;</span><span class="p">]</span><span class="c1">#.groupby([&#39;Year&#39;]).apply(grouping_stat, numeric_only=True)</span>
        <span class="n">df_autumn</span> <span class="o">=</span> <span class="n">binned</span><span class="p">[</span><span class="n">binned</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="s1">&#39;SON&#39;</span><span class="p">]</span><span class="c1">#.groupby([&#39;Year&#39;]).apply(grouping_stat, numeric_only=True)</span>

        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_winter</span><span class="p">,</span> <span class="n">df_spring</span><span class="p">,</span> <span class="n">df_summer</span><span class="p">,</span> <span class="n">df_autumn</span><span class="p">]</span>


        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">binned_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;AS&#39;</span><span class="p">))]</span> <span class="c1">#binned.groupby(pd.Grouper(freq=&#39;AS&#39;)).apply(grouping_stat, numeric_only=True)</span>
            <span class="n">binned_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">categories_labels</span><span class="p">)</span>


            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binned_list</span><span class="p">)):</span>
                <span class="c1">#binned_list[i][&#39;freq&#39;] = 0.0</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">binned_list_freq</span><span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">binned_list_freq</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
                <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="c1">#</span>

                <span class="n">binned_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">binned_df</span><span class="p">,</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">binned_df</span> <span class="o">=</span> <span class="n">binned_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

            <span class="n">binned_df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">categories_colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                            <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.185</span><span class="p">),</span>
                            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="c1"># Plot always 7 labels at most</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">binned_df</span><span class="o">.</span><span class="n">index</span>
            <span class="n">xticks_spacing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[::</span><span class="n">xticks_spacing</span><span class="p">])</span> <span class="c1">#.values)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>

            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>

            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">([</span><span class="s1">&#39;December-January-February&#39;</span><span class="p">,</span> <span class="s1">&#39;March-April-May&#39;</span><span class="p">,</span> <span class="s1">&#39;June-July-August&#39;</span><span class="p">,</span> <span class="s1">&#39;September-October-November&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">categories_labels</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.12</span><span class="p">,</span><span class="mf">1.055</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency [%]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency [%]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.031</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="c1">#plt.suptitle(&#39;%s evolution and %i-period mean&#39; %(var, averaging_period), fontsize=22, y=0.97)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">] grouped by categories&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.975</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span>

        <span class="n">df_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">month_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;January&#39;</span><span class="p">,</span> <span class="s1">&#39;February&#39;</span><span class="p">,</span> <span class="s1">&#39;March&#39;</span><span class="p">,</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;June&#39;</span><span class="p">,</span> <span class="s1">&#39;July&#39;</span><span class="p">,</span> <span class="s1">&#39;August&#39;</span><span class="p">,</span> <span class="s1">&#39;September&#39;</span><span class="p">,</span> <span class="s1">&#39;October&#39;</span><span class="p">,</span> <span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="s1">&#39;December&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">):</span>
            <span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned</span><span class="p">[</span><span class="n">binned</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">j</span><span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">15.5</span><span class="p">,</span><span class="mf">12.25</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
            <span class="n">binned_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;AS&#39;</span><span class="p">))]</span> <span class="c1">#binned.groupby(pd.Grouper(freq=&#39;AS&#39;)).apply(grouping_stat, numeric_only=True)</span>
            <span class="n">binned_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">categories_labels</span><span class="p">)</span>
            <span class="c1">#binned_df.columns = categories_labels</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binned_list</span><span class="p">)):</span>
                <span class="c1">#binned_list[i][&#39;freq&#39;] = 0.0</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">binned_list_freq</span><span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">binned_list_freq</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
                <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

<span class="c1">#                binned_df = pd.concat([binned_df, binned_list[i][&#39;%s&#39; %year]], axis=1)</span>
                <span class="n">binned_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">binned_df</span><span class="p">,</span> <span class="n">binned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">binned_df</span> <span class="o">=</span> <span class="n">binned_df</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">binned_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">binned_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#pd.to_datetime(binned_df.index)</span>

            <span class="n">binned_df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">categories_colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.991</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">AnchoredText</span><span class="p">(</span><span class="s1">&#39;Alejandro Rodríguez Sánchez&#39;</span><span class="p">,</span>
                            <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.185</span><span class="p">),</span>
                            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">text</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="c1">#fig.autofmt_xdate()</span>

            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>

            <span class="c1"># Plot always 7 labels at most</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">binned_df</span><span class="o">.</span><span class="n">index</span>
            <span class="n">xticks_spacing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[::</span><span class="n">xticks_spacing</span><span class="p">])</span> <span class="c1">#.values)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">categories_labels</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">.01</span><span class="p">,</span><span class="mf">1.075</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">month_names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency [%]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency [%]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency [%]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency [%]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.031</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Period with data: </span><span class="si">%i</span><span class="s1">-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yearmin</span><span class="p">,</span><span class="n">yearmax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Database: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">database</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">,</span> <span class="s1">&#39;Location: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">station_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">transFigure</span><span class="p">)</span>
        <span class="c1">#plt.suptitle(&#39;%s evolution and %i-period mean&#39; %(var, averaging_period), fontsize=22, y=0.97)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">] grouped by categories&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">units</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.975</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.035</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Alejandro Rodríguez Sánchez.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
